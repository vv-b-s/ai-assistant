<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.22">
<title>Build your AI assistant with Ollama, LLM and Spring</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Asciidoctor Tabs | Copyright (c) 2018-present Dan Allen | MIT License */
.tabs {
    margin-bottom: 1.25em;
}

.tablist > ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    margin: 0;
    padding: 0;
}

.tablist > ul li {
    align-items: center;
    background-color: #fff;
    cursor: pointer;
    display: flex;
    font-weight: bold;
    line-height: 1.5;
    padding: 0.25em 1em;
    position: relative;
}

.tablist > ul li:focus-visible {
    outline: none;
}

.tablist.ulist,
.tablist.ulist > ul li {
    margin: 0;
}

.tablist.ulist > ul li + li {
    margin-left: 0.25em;
}

.tabs .tablist li::after {
    content: "";
    display: block;
    height: 1px;
    position: absolute;
    bottom: -1px;
    left: 0;
    right: 0;
}

.tabs.is-loading .tablist li:not(:first-child),
.tabs:not(.is-loading) .tablist li:not(.is-selected) {
    background-color: #f5f5f5;
}

.tabs.is-loading .tablist li:first-child::after,
.tabs:not(.is-loading) .tablist li.is-selected::after {
    background-color: #fff;
}

/*
.tabs:not(.is-loading) .tablist li,
.tabs:not(.is-loading) .tablist li::after {
  transition: background-color 200ms ease-in-out;
}
*/

.tablist > ul p {
    line-height: inherit;
    margin: 0;
}

.tabpanel {
    background-color: #fff;
    padding: 1.25em;
}

.tablist > ul li,
.tabpanel {
    border: 1px solid #dcdcdc;
}

.tablist > ul li {
    border-bottom: 0;
}

.tabs.is-loading .tabpanel + .tabpanel,
.tabs:not(.is-loading) .tabpanel.is-hidden {
    display: none;
}

.tabpanel > :first-child {
    margin-top: 0;
}

/* #content is a signature of the Asciidoctor standalone HTML output */
#content .tabpanel > :last-child,
#content .tabpanel > :last-child > :last-child,
#content .tabpanel > :last-child > :last-child > li:last-child > :last-child {
    margin-bottom: 0;
}

.tablecontainer {
    overflow-x: auto;
}

#content .tablecontainer {
    margin-bottom: 1.25em;
}

#content .tablecontainer > table.tableblock {
    margin-bottom: 0;
}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Build your AI assistant with Ollama, LLM and Spring</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_and_so_we_meet_lets_get_to_know_each_other">1.1. And so we meet. Let&#8217;s get to know each other&#8230;&#8203;</a></li>
</ul>
</li>
<li><a href="#_project_structure">2. Project Structure</a>
<ul class="sectlevel2">
<li><a href="#_component_diagram">2.1. Component Diagram</a></li>
<li><a href="#_high_level_overview">2.2. High-Level Overview</a></li>
</ul>
</li>
<li><a href="#_project_setup">3. Project Setup</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_springboot_application">3.1. Setting up the SpringBoot application</a></li>
<li><a href="#_the_docker_set_up">3.2. The Docker set-up</a></li>
</ul>
</li>
<li><a href="#_setting_up_the_database">4. Setting up the database</a>
<ul class="sectlevel2">
<li><a href="#_the_full_database_in_a_diagram">4.1. The full database in a diagram</a></li>
<li><a href="#_building_the_entities">4.2. Building the entities</a></li>
</ul>
</li>
<li><a href="#_setting_up_the_endpoints">5. Setting up the endpoints</a>
<ul class="sectlevel2">
<li><a href="#_usercontroller">5.1. <code>UserController</code></a></li>
<li><a href="#_mealcontroller">5.2. <code>MealController</code></a></li>
<li><a href="#_the_fooditemcontroller">5.3. The <code>FoodItemController</code></a></li>
</ul>
</li>
<li><a href="#_generating_data_with_llm">6. Generating data with LLM</a>
<ul class="sectlevel2">
<li><a href="#_the_nutrientgenerator_our_first_llm_generator">6.1. The <code>NutrientGenerator</code>, our first LLM generator</a></li>
<li><a href="#_caloricinformationgenerator">6.2. <code>CaloricInformationGenerator</code></a></li>
<li><a href="#_mealreviewgenerator">6.3. <code>MealReviewGenerator</code></a></li>
<li><a href="#_conclusion">6.4. Conclusion</a></li>
</ul>
</li>
<li><a href="#_app_optimisations_and_ideas">7. App optimisations and ideas</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_asynchronous_calls_to_the_llm">7.1. Setting up Asynchronous calls to the LLM</a></li>
<li><a href="#_logging_important_application_events">7.2. Logging important application events</a></li>
<li><a href="#_additional_ideas_to_look_far_and_beyond">7.3. Additional ideas to look far and beyond</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_and_so_we_meet_lets_get_to_know_each_other">1.1. And so we meet. Let&#8217;s get to know each other&#8230;&#8203;</h3>
<div class="paragraph">
<p>Hey there!
You have probably read the title and the description of this workshop, but to make sure we are on the same page,
I&#8217;ll try to answer some questions in this chapter.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What is this workshop for?</div>
<div class="paragraph">
<p>Obviously, building an AI assistant&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Okay, this is not a good explanation. Let&#8217;s break it down a bit.</p>
</div>
<div class="paragraph">
<p>The idea of this workshop is to show you how you can utilize the power of Large Language Models (LLMs) in your web
application and make it even more flexible.
There are a plethora of use cases where you can combine LLMs with the business logic of a server application,
with only your imagination as the limitation.</p>
</div>
<div class="paragraph">
<p>Unlike simple tutorials that show API calls, this workshop will take a practical, hands-on approach.
By the end, you will have a working web application that leverages an LLM for real-world tasks.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">How does this suit me?</div>
<div class="paragraph">
<p>This suits you in many ways.
Have you ever thought of a scenario where your application has a lot of input data that needs a human-like approach to analyze?
Let&#8217;s look at some examples:</p>
</div>
<div class="paragraph">
<p><strong>Example 1:</strong>
<br>
You&#8217;re building an app that tracks people&#8217;s fitness and eating habits.
The app monitors metrics like the person&#8217;s bodily parameters (weight, height, age, gender, etc.),
and it also tracks their eating habits, including the foods and meals they consume, caloric intake, nutritional levels, and so on.
Usually, you would need someone to enter the data of each food, determine its nutrient content, and add logic to combine
these parameters in a scientifically proven method that will inform the user about their health choices.</p>
</div>
<div class="paragraph">
<p>The problem?
<br>
You can&#8217;t manage all the foods in the world and find out all the information that your app needs to provide proper information to the user.
Also, one size does not fit all.
What if you needed to output information that is more targeted to the user?</p>
</div>
<div class="paragraph">
<p>The solution?
<br>
You integrate an LLM into your application.
You add a specific prompt, customized to the user&#8217;s needs, and ask it to return the appropriate data.
The LLM can be used to look up nutritional data and process health insights tailored to the user&#8217;s needs.
The data can also be saved to the database to be reused for other users who might have the same requirements.</p>
</div>
<hr>
<div class="paragraph">
<p><strong>Example 2:</strong>
<br>
You build librarian software.
Your application keeps track of all the books contained within a library.
It also knows where each book can be found.
Your application searches for the right book, tracks book rentals, and helps users navigate to the right section.</p>
</div>
<div class="paragraph">
<p>The problem?
<br>
What if you wanted your application to do a bit more? For example, give appropriate recommendations to the user based on a description of what they are looking for, or let the app recommend books from your library to that user based on their ratings of previous books?</p>
</div>
<div class="paragraph">
<p>The solution?
<br>
Use an LLM.
You can create specific LLM prompts that include the user&#8217;s description of the book, their preferences, and ratings of previous readings.
The LLM could be trained on book knowledge, and you can even implement logic where the LLM interacts with your application, asking if this book is in the library or not, so it can build up a list of the books that are only present within your library.</p>
</div>
<hr>
<div class="paragraph">
<p><strong>Example 3:</strong></p>
</div>
<div class="paragraph">
<p>You are building a home assistant server capable of managing your smart devices.
The server&#8217;s API accepts specific intents that trigger hardcoded scenarios to switch on/off lights, collect data from sensors, etc.</p>
</div>
<div class="paragraph">
<p>The problem?
<br>
You want your server to be smarter.
You want your intents to be more flexible.
For example, when you say "Lights on!" to your voice assistant, you want it to turn on certain lights, depending on the time and atmosphere you desire.</p>
</div>
<div class="paragraph">
<p>The solution?
<br>
You can integrate an LLM into the server.
Your server will forward the voice input from a third-party assistant like Google Home or Alexa and prompt your LLM to
identify the intent and query the right devices.
The LLM will then return a proper response that is read by the home assistant and will trigger the smart devices that
it determines need to be activated according to the prompt.</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To keep this section brief, I am providing vague examples here.
All of these will have their specific constraints and challenges, but none of them are impossible.
You can think of any task that requires more abstract thinking and assign an LLM to do it for you.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Okay! I&#8217;m convinced! Where do we go from here?</div>
<div class="paragraph">
<p>To start off, you&#8217;re in the right place!
In this workshop, we are going to build such a solution by delving deeper into one of the aforementioned examples.
We will build a web application server that will gather input from the user and consult an LLM for the things that we can&#8217;t or don&#8217;t want to figure out on our own.
For that purpose, I am going to show you how to implement the first example.</p>
</div>
<div class="paragraph">
<p>We will build an application that gathers information about the eating habits of a user and uses an LLM to determine nutritional facts about the food they consume.
As a result, we will provide each user with proper information about their eating habits and generate a review based on the items they consumed.
This will help the user make better and healthier food choices that are more in tune with their personal bodily parameters.</p>
</div>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">What&#8217;s the technology stack we&#8217;re going to use?</div>
<div class="paragraph">
<p>The technology stack is straightforward and requires minimal setup on your side.
Here is what we&#8217;re going to use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Spring Boot framework</strong> - the core of our application, handling API requests and processing data.</p>
</li>
<li>
<p><strong>PostgreSQL database</strong> - stores user input and processed nutritional data from the LLM.</p>
</li>
<li>
<p><strong>Ollama server</strong> - a locally hosted web server that enables API communication with an LLM model.</p>
</li>
<li>
<p><strong>Llama LLM</strong> - the chosen LLM for this workshop, due to its lightweight models that can run on most modern machines.</p>
</li>
<li>
<p><strong>Docker</strong> - used to simplify setup by providing a Docker Compose script for database and Ollama server management.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are not doing fine-tuning in this workshop.
Instead, we will focus on prompt engineering and API-based interaction with pre-trained LLMs.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">But isn&#8217;t running an LLM locally slow? (The system requirements)</div>
<div class="paragraph">
<p>Running an LLM locally can be resource-intensive, but for the small-scale tasks in this workshop, most modern machines should handle it fine.</p>
</div>
<div class="paragraph">
<p><strong>Recommended system requirements:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>A computer running macOS, Linux, or Windows</strong> (<strong>with WSL installed!</strong>)</p>
</li>
<li>
<p><strong>At least 16GB of RAM</strong> - LLMs are memory-intensive.</p>
</li>
<li>
<p><strong>A modern CPU</strong> - the more cores, the better.</p>
</li>
<li>
<p><strong>At least 50GB of free disk space</strong> - required for the LLM model, Docker images, and dependencies.</p>
</li>
<li>
<p><strong>A dedicated GPU</strong> - optional, but it significantly improves performance if properly configured.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that we&#8217;re all set, let&#8217;s move to the next chapter, where I will take you through our project design and show you the big picture.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_structure">2. Project Structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we begin, let&#8217;s take a step back and visualize what we&#8217;re building.
Think of this as assembling a high-performance team, where each component plays a crucial role.
This section will guide you through how everything fits together.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll start with a high-level diagram that paints the big picture.</p>
</div>
<div class="sect2">
<h3 id="_component_diagram">2.1. Component Diagram</h3>
<div class="paragraph">
<p>At its core, our system consists of several key components working together like a well-oiled machine:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/component-diagram.svg" alt="component diagram">
</div>
<div class="title">Figure 1. Component Diagram</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Spring Boot API Server</strong> - The central hub of our web application service.
This is where user interactions happen, prompts are processed, and responses from the LLM are handled.</p>
</li>
<li>
<p><strong>Ollama API Server</strong> - Acting as the bridge to the LLM, this component makes AI integration straightforward.
With Spring Boot&#8217;s powerful plugins, we can connect it with minimal configuration and call its methods efficiently.</p>
</li>
<li>
<p><strong>LLM Model</strong> - The brain of our intelligent web application.
This is where the real magic happens.
It processes user input, analyzes context, and crafts meaningful responses based on its training data.</p>
</li>
<li>
<p><strong>PostgreSQL Database</strong> - Our knowledge repository.
It stores user input, processed data, and LLM responses, helping us avoid redundant queries and making the system more
efficient over time.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_high_level_overview">2.2. High-Level Overview</h3>
<div class="paragraph">
<p>To bring this structure to life, let&#8217;s walk through a real-world example.
Imagine a user interacting with our AI-powered nutrition assistant.
How does their request travel through the system?
Let&#8217;s have look at some use cases that will show you the big picture, shall we?</p>
</div>
<div class="sect3">
<h4 id="_registering_information">2.2.1. Registering information</h4>
<div class="paragraph">
<p>Imagine using the app for the first time‚Äîfresh start, no data.
That means we‚Äôll need to query the LLM frequently at the beginning.
But as time passes, the app becomes smarter.
When a user repeats requests, the database will already contain previous LLM responses, reducing unnecessary queries and
making the system faster over time.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/user-creates-a-meal.svg" alt="user creates a meal">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user creates an account, providing essential details like name, age, gender, height, weight, and recommended daily caloric intake.</p>
</li>
<li>
<p>The API processes this information and stores it in the database.</p>
</li>
<li>
<p>The system confirms that the data has been saved, allowing the user to start adding meal information.</p>
</li>
<li>
<p>The user logs a meal by calling an API endpoint (e.g., [5xüçÖ, 1xüçï, 3xü•ö]).</p>
</li>
<li>
<p>The server processes and saves the meal data.</p>
</li>
<li>
<p>A confirmation is sent back to the user.</p>
</li>
<li>
<p>The system checks if any foods are missing detailed nutritional information, such as calories, nutrients, and allergens.</p>
</li>
<li>
<p>If necessary, the server builds a custom prompt for the LLM, requesting details for new food items.</p>
</li>
<li>
<p>Ollama receives the prompt and sends it to the LLM.</p>
</li>
<li>
<p>The LLM works its magic, analyzing the data and generating a response.</p>
</li>
<li>
<p>The response is passed back to Ollama.</p>
</li>
<li>
<p>The formatted response is returned to the Spring Boot server.</p>
</li>
<li>
<p>The server extracts and validates the information.
Any errors or inconsistencies are handled to prevent storing inaccurate data.</p>
</li>
<li>
<p>Once validated, the enriched data is saved in the database for future use, reducing the need for repeated LLM queries.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since LLM queries take time, we delegate these tasks to an asynchronous thread.
This ensures the user doesn&#8217;t have to wait for a response while the system processes the data in the background.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_requesting_food_information">2.2.2. Requesting food information</h4>
<div class="paragraph">
<p>Sometimes, users may want to check the nutritional details of specific foods before consuming them.
Our system will allow users to retrieve this data on demand, ensuring they make informed choices.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/user-requests-food-details.svg" alt="user requests food details">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user queries the app for food details (e.g., [üçÖ, üçÜ, üçä]).</p>
</li>
<li>
<p>The server checks whether the requested food items already exist in the database.</p>
</li>
<li>
<p>If the data exists, the system formats it and returns it to the user,
and if any information is missing, the user is notified that data is being generated and should check back later.</p>
</li>
<li>
<p>Meanwhile, the server builds a structured prompt for the LLM to request missing food details.</p>
</li>
<li>
<p>The LLM processes the request and returns the necessary nutritional data.</p>
</li>
<li>
<p>The response is validated.</p>
</li>
<li>
<p>The data parsed, and stored in the database.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next time the user requests the same food, the data will be available instantly‚Äîno need to wait for LLM processing!</p>
</div>
</div>
<div class="sect3">
<h4 id="_asking_for_meal_review">2.2.3. Asking for meal review</h4>
<div class="paragraph">
<p>Now that users can log meals, they might wonder:
<strong>How healthy was my last meal?</strong>
This is where the LLM steps in as a virtual nutritionist, analyzing the user‚Äôs meal and providing personalized feedback.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/user-requests-meal-review.svg" alt="user requests meal review">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user enters their meal details ([6xüçå, 1xü•î, 0.5xü´ö]).</p>
</li>
<li>
<p>The server saves this data into the relevant database entities.</p>
</li>
<li>
<p>The user gets an immediate confirmation.</p>
</li>
<li>
<p>Behind the scenes, the system retrieves the meal data and relevant user attributes (age, gender, weight, height).</p>
</li>
<li>
<p>A detailed prompt is generated for the LLM, asking it to analyze the meal and provide a review based on the user‚Äôs profile.</p>
</li>
<li>
<p>The LLM processes the request.</p>
</li>
<li>
<p>Ollama returns an insightful meal review.</p>
</li>
<li>
<p>The response is stored in the database alongside the meal entry.</p>
</li>
<li>
<p>The user later requests a review for their meal.</p>
</li>
<li>
<p>The system retrieves the analysis along with the meal data.</p>
</li>
<li>
<p>A response is returned to the user.
If the review is still being processed, the system informs the user to check back soon.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>These are just a few examples of how an LLM can enhance an application like this.
But the possibilities don‚Äôt stop here!
You can take what you‚Äôve learned and expand this project with new features and use cases.
Get creative!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the next chapter we are going to start setting up our project, so we are ready to dig in and make each of these use cases
come to life.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_setup">3. Project Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Setting up the project should be pretty straight forward.
If you feel any struggle, you can always checkout to the <a href="https://github.com/vv-b-s/ai-assistant/tree/solution">solution</a> branch where you will find the <code>code</code> directory in the file tree, but keep in mind that learning through error
is the best approach to get the most out of this workshop, so don&#8217;t give into the frustration!</p>
</div>
<div class="sect2">
<h3 id="_setting_up_the_springboot_application">3.1. Setting up the SpringBoot application</h3>
<div class="paragraph">
<p>Provisioning a SpringBoot app, should be a fairly easy task. You can just simply click <a href="https://start.spring.io/#!type=gradle-project&amp;language=java&amp;platformVersion=3.5.5&amp;packaging=jar&amp;jvmVersion=17&amp;groupId=com.contoso&amp;artifactId=adviser&amp;name=adviser&amp;description=Nutrition%20adviser&amp;packageName=com.contoso.adviser&amp;dependencies=spring-ai-ollama,data-jpa,web,actuator,devtools,postgresql,lombok">this link</a> or visit <a href="https://start.spring.io" class="bare">https://start.spring.io</a>
and configure your application from there.</p>
</div>
<div class="paragraph">
<p>If you choose the latter, make sure to set up your application like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/spring-initializer.png" alt="spring initializer">
</div>
</div>
<div class="paragraph">
<p>Once your set-up is complete, download the archive extract it and open it in your IDE.
Most popular IDEs will instantly recognize it&#8217;s a Gradle/Maven project and will set everything up for you.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In case you don&#8217;t want to run your project through an IDE or have any issues with setting up gradle, you can always use the built-in <code>gradlew</code> script, coming with your packed project.</p>
</div>
<div class="paragraph">
<p>To run the application from the terminal, you can execute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#assuming ./ is the root of your extracted project.
./gradlew boot run</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>But hold your horses! We&#8217;re not done setting up the project yet.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="_the_docker_set_up">3.2. The Docker set-up</h3>
<div class="paragraph">
<p>The first step of making our project is ensuring that all the supporting structure is up and running.
For that you will need to have docker installed on your machine.
We will create three files, that will orchestrate the rest.</p>
</div>
<div class="sect3">
<h4 id="_docker_compose_yml">3.2.1. docker-compose.yml</h4>
<div class="paragraph">
<p>Inside your project directory, create a file, named <code>docker-compose.yml</code>.
The contents of this file should be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">version</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'3'</span></span>
<span style="color:#606">volumes</span>:
  <span style="color:#606">database</span>:
  <span style="color:#606">cache</span>:

<span style="color:#606">services</span>:

  <span style="color:#606">postgres</span>:
    <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">postgres:14.2</span></span>
    <span style="color:#606">restart</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">always</span></span>
    <span style="color:#606">volumes</span>: <i class="conum" data-value="1"></i><b>(1)</b>
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./docker/database/data:/var/lib/postgresql/data</span></span>
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./docker/database/postgres:/docker-entrypoint-initdb.d</span></span>
    <span style="color:#606">ports</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">5432:5432</span><span style="color:#710">&quot;</span></span>
    <span style="color:#606">environment</span>: <i class="conum" data-value="2"></i><b>(2)</b>
      <span style="color:#606">POSTGRES_PASSWORD</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">adviser</span></span>
      <span style="color:#606">POSTGRES_USER</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">adviser</span></span>
      <span style="color:#606">DATABASES</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">adviser</span></span>

  <span style="color:#606">ollama</span>:
    <span style="color:#606">build</span>:
      <span style="color:#606">context</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">.  </span></span><i class="conum" data-value="3"></i><b>(3)</b>
      <span style="color:#606">dockerfile</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./Dockerfile.ollama </span></span><i class="conum" data-value="4"></i><b>(4)</b>
    <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ollama</span></span>
    <span style="color:#606">container_name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ollama</span></span>
    <span style="color:#606">entrypoint</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">/tmp/run-ollama.sh </span></span><i class="conum" data-value="5"></i><b>(5)</b>
    <span style="color:#606">environment</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">OLLAMA_HOST=0.0.0.0</span></span>
    <span style="color:#606">ports</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">11434:11434</span></span>
    <span style="color:#606">volumes</span>: <i class="conum" data-value="6"></i><b>(6)</b>
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./docker/ollama/app:/app/</span></span>
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./docker/ollama/ollama:/root/.ollama</span></span>
    <span style="color:#606">tty</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>
    <span style="color:#606">restart</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">always</span></span>
<span style="color:#777">#Uncomment to enable GPU capabilities (https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html)</span>
<span style="color:#777">#    deploy:</span>
<span style="color:#777">#      resources:</span>
<span style="color:#777">#        reservations:</span>
<span style="color:#777">#          devices:</span>
<span style="color:#777">#            - driver: nvidia</span>
<span style="color:#777">#              count: 1</span>
<span style="color:#777">#              capabilities: [ gpu ]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We choose to place the database content in a visible volume folder within the project.
This will help you manage and move your project files easily between environments, without having to wonder where they went.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For ease of use, we pre-configure a database, called <code>adviser</code> with a user <code>adviser</code> and password <code>adviser</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Determines the root of your docker configuration.
Make sure that you place your docker configuration files in the path specified by this parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>For Ollama we will use a special <code>Dockerfile</code>, in order to tell the container to download the LLM automatically.
This is rather a workaround, as the official Ollama containers do not support this out of the box.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Additionally, we will need a special script, which is going to be run within the Ollama container to initiate Ollama
and tell it to pull the required image if missing.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The files pulled by Ollama will also be stored in their own folder, within the project directory.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you feel more adventurous, you can try running Ollama on your graphics card.
This will improve the LLM response time significantly, although setting up this feature, requires you to install <a href="https://developer.nvidia.com/cuda-toolkit">Nvidia CUDA
drivers</a>, and <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html">Nvidia pass-through for Docker</a> containers.
These steps are not covered by this workshop, so please refer to the respective tutorials, if you want to delve in to that any further.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_dockerfile">3.2.2. The Dockerfile</h4>
<div class="paragraph">
<p>Once we have <code>docker-compose.yml</code>, we can proceed creating the docker file within the same folder.
Create a file, named <code>Dockerfile.ollama</code>, with the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="dockerfile">FROM ollama/ollama

COPY ./run-ollama.sh /tmp/run-ollama.sh <i class="conum" data-value="1"></i><b>(1)</b>

WORKDIR /tmp

RUN chmod +x run-ollama.sh

EXPOSE 11434 <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The left hand of the <code>COPY</code> command is the place where the <code>run-ollama.sh</code> file is located, the right hand is
where the file will be copied inside the container.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>With the <code>EXPOSE</code> command we tell Docker to open port <code>11434</code>, which is the default port to access the Ollama API.
(Make sure it&#8217;s not used! üòú)</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_run_ollama_sh">3.2.3. <code>run-ollama.sh</code></h4>
<div class="paragraph">
<p>One final file for this part - the <code>run-ollama.sh</code> file.
Again create it in the same folder, and add the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#!/bin/bash

echo &quot;Starting Ollama server...&quot;
ollama serve &amp;
ollama run llama3.2:3b <i class="conum" data-value="1"></i><b>(1)</b>


echo &quot;Waiting for Ollama server to be active...&quot;
while [ &quot;$(ollama list | grep 'NAME')&quot; == &quot;&quot; ]; do
  sleep 1
done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the place, where we tell Ollama, which model to install.
You can go with the one given here, or choose your own favorite flavour of LLM, just keep in mind that each LLM responds differently,
and you might get different results or processing times if you go with a different LLM.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that we have all the files created let&#8217;s open a terminal into the containing folder and run <code>docker-compose up</code> (or <code>docker compose up</code> depending on your version).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Thi installation will take same time, so do be patient!
It will first download all the required docker images, and then will attempt to pull your LLM model.
The whole set-up will take around 4GB of your hard drive.</p>
</li>
<li>
<p>During the build of the <code>ollama</code> image it is possible to get the following error:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">ollama Warning pull access denied for ollama, repository does not exist or may require 'docker login': denied: requested access to the resource is denied</code></pre>
</div>
</div>
<div class="paragraph">
<p>This message is misleading.
The reason this is happening is due to docker compose caching.
Here&#8217;s how to troubleshoot this error:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that the <code>Dockerfile.ollama</code> is properly specified in the <code>docker-compose.yml</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yml">    <span style="color:#F00;background-color:#FAA">...</span>
 <span style="color:#606">ollama</span>:
    <span style="color:#606">build</span>:
      <span style="color:#606">context</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">.</span></span>  <span style="color:#777">#should be the root of your Dockerfile</span>
      <span style="color:#606">dockerfile</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./Dockerfile.ollama</span></span> <span style="color:#777">#should be the path of your Dockerfile</span>
    <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ollama</span></span>
    <span style="color:#F00;background-color:#FAA">...</span></code></pre>
</div>
</div>
</li>
<li>
<p>Inside the docker-compose.yml folder, run the following command to tell docker to avid using cached data:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker compose build --no-cache ollama</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once everything is completed you should see the following text in your terminal</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/docker-ready.png" alt="docker ready">
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s make sure all the components are working&#8230;&#8203;</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For the database, you can try to connect directly from your IDE&#8217;s database plugin.
You will need that to access your data manually anyway.
If you entered everything correctly you should be able to connect to it.</p>
<div class="imageblock text-center">
<div class="content">
<img src="img/database-ready.png" alt="database ready">
</div>
</div>
</li>
<li>
<p>To check if Ollama is working, simply make a GET request to <code>localhost:11434</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -v localhost:11434</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a response you should get</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">* Host localhost:11434 was resolved.
* IPv6: ::1
* IPv4: 127.0.0.1
*   Trying [::1]:11434...
* Connected to localhost (::1) port 11434
&gt; GET / HTTP/1.1
&gt; Host: localhost:11434
&gt; User-Agent: curl/8.5.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Type: text/plain; charset=utf-8
&lt; Date: Thu, 03 Apr 2025 17:47:26 GMT
&lt; Content-Length: 17
&lt;
* Connection #0 to host localhost left intact
Ollama is running</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>If that is all set, we can move tho the next step.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_ollama_and_database_with_the_application">3.2.4. Connecting Ollama and Database with the application</h4>
<div class="paragraph">
<p>Before firing up our application for the first time, we need to provide it with the configuration it depends on.
To do so, we will need to modify the <code>application.properties</code> file, located under <code>src/main/resources</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">spring.application.name=adviser
spring.datasource.driver-class-name=org.postgresql.Driver
spring.datasource.username=adviser
spring.datasource.password=adviser
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.datasource.url=jdbc:postgresql://localhost:5432/adviser
spring.jpa.hibernate.ddl-auto=update <i class="conum" data-value="1"></i><b>(1)</b>

spring.ai.ollama.base-url=http://localhost:11434
spring.ai.ollama.chat.options.model=llama3.2:3b <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the newbies here, this setting will help us generate all the database tables automatically and keep it up to date with any
future changes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the model should mirror exactly what is written in <code>run-ollama.sh</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you can run the application to see if it boots up correctly.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_our_first_endpoint">3.2.5. Creating our first endpoint</h4>
<div class="paragraph">
<p>To make sure that all of our components are configured correctly, we will create the base of our application.
To start off, make sure to follow the same project structure.
It will make it easier to navigate throughout this workshop.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="img/project-structure.png" alt="project structure">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the controller folder create a class called <code>HelloController.java</code>.
This will be our welcoming point that checks if everything is up and running.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">com.contoso.adviser.controller</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.AllArgsConstructor</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.web.bind.annotation.GetMapping</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.web.bind.annotation.RequestMapping</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.web.bind.annotation.RestController</span>;

<span style="color:#007">@RestController</span>
<span style="color:#007">@AllArgsConstructor</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/hello</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">HelloController</span> {

    <span style="color:#007">@GetMapping</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> sayHello() {
        <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello!</span><span style="color:#710">&quot;</span></span>;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you visit <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a>, you should get a <code>Hello!</code> response.</p>
</div>
<div class="paragraph">
<p>Hurry! üéâü•≥</p>
</div>
<div class="paragraph">
<p>This means that your application is up and running.</p>
</div>
</li>
<li>
<p>The next step is to add our first database entity.
Create a class called <code>User</code> within the <code>model</code> folder:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">com.contoso.adviser.model</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">jakarta.persistence</span>.*;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.AllArgsConstructor</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Getter</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.NoArgsConstructor</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Setter</span>;

<span style="color:#007">@Getter</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#007">@Setter</span>
<span style="color:#007">@NoArgsConstructor</span>
<span style="color:#007">@Entity</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">users</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">User</span> {

    <span style="color:#007">@Id</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> id;

    <span style="color:#007">@Version</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> version;

    <span style="color:#088;font-weight:bold">public</span> User(<span style="color:#0a8;font-weight:bold">String</span> firstName) {
        <span style="color:#950">this</span>.firstName = firstName;
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> firstName; <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For ease of use we are going to use Project Lombok, to skip some boilerplateing, making getters and setters</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>id</code> and <code>version</code> are properties automatically managed by Hibernate.
They are crucial for every database entity we create.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the first column we are going to see in the database.
Further on, we will add more properties to this entity.</td>
</tr>
</table>
</div>
</li>
<li>
<p>The next step will be to crete the <code>UserRepository</code> class under the <code>repository</code> package.
This will allow us to access the data related to the User entity:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">com.contoso.adviser.repository</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">com.contoso.adviser.model.User</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.data.repository.CrudRepository</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype.Repository</span>;

<span style="color:#007">@Repository</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">UserRepository</span> <span style="color:#088;font-weight:bold">extends</span> CrudRepository&lt;User, <span style="color:#0a8;font-weight:bold">Long</span>&gt; {
}</code></pre>
</div>
</div>
</li>
<li>
<p>Now we need to go back to our <code>HelloController</code> and modify our endpoint to accept names.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="jave">@RestController
@AllArgsConstructor <i class="conum" data-value="1"></i><b>(1)</b>
@RequestMapping(&quot;/hello&quot;)
public class HelloController {

    private final UserRepository userRepository; <i class="conum" data-value="2"></i><b>(2)</b>

    @GetMapping
    public String sayHello(@RequestParam String name) {
        User user = new User(name);
        userRepository.save(user);
        return &quot;Hello, %s&quot;.formatted(user.getFirstName());
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add <code>@AllArgsConstructor</code> annotation to ensure the injection of <code>UserRepository</code> inside the controller.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Injecting <code>UserRepository</code> is as simple as defining it.
<div class="paragraph">
<p>Now when we call <a href="http://localhost:8080/hello?name=John" class="bare">http://localhost:8080/hello?name=John</a>, for example, we should get <code>Hello, John</code> in the response, and have
John persisted in the database. Another module completed!</p>
</div></td>
</tr>
</table>
</div>
</li>
<li>
<p>Time to set up the communication with Ollama.
Inside the <code>ai</code> package, create a service class, called <code>OllamaAIService</code>.
This class will serve as a facade, when we want to call Ollama and the LLM:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">com.contoso.adviser.ai</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.AllArgsConstructor</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.ai.chat.messages.SystemMessage</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.ai.chat.messages.UserMessage</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.ai.chat.prompt.Prompt</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.ai.ollama.OllamaChatModel</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.stereotype.Service</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">java.util.List</span>;

<span style="color:#007">@Service</span>
<span style="color:#007">@AllArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OllamaAiService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> PROMPT_GENERAL_INSTRUCTIONS = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> <i class="conum" data-value="1"></i><b>(1)</b>
        Here are the general guidelines to answer the `user_main_prompt`

        </span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>;


    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> CURRENT_PROMPT_INSTRUCTIONS = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> <i class="conum" data-value="2"></i><b>(2)</b>

        Here's the `user_main_prompt`:


        </span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>;


    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OllamaChatModel client;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> call(<span style="color:#0a8;font-weight:bold">String</span> instructions, <span style="color:#0a8;font-weight:bold">String</span> request) {
        <span style="color:#339;font-weight:bold">var</span> generalInstructions = <span style="color:#080;font-weight:bold">new</span> SystemMessage(PROMPT_GENERAL_INSTRUCTIONS.concat(instructions));
        <span style="color:#339;font-weight:bold">var</span> promptMessage = <span style="color:#080;font-weight:bold">new</span> UserMessage(CURRENT_PROMPT_INSTRUCTIONS.concat(request));

        <span style="color:#339;font-weight:bold">var</span> prompt = <span style="color:#080;font-weight:bold">new</span> Prompt(<span style="color:#0a8;font-weight:bold">List</span>.of(generalInstructions, promptMessage));
        <span style="color:#080;font-weight:bold">return</span> client.call(prompt).getResult().getOutput().getText();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting the template for the LLM&#8217;s purpose</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting the template for the user&#8217;s prompt.
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>LLMs work through text communication. A user prompt contains manly two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>System prompt</strong> - it determines the purpose of the LLM.
A LLM is intended to have knowledge in many fields.
Due to this reason it has to understand different contexts.
A drawback of that is that when it&#8217;s asked to do a certain task, it might not get it correctly, or it might not give us the expected response.
The solution is to assign a role to the LLM, define what our input is going to be and what output we expect.
This will help it better act as the thin we want it to be.</p>
</li>
<li>
<p><strong>User prompt</strong> - a reflection of the system prompt is the user prompt.
Once the LLM has its role assigned, all the input from the user will be treated in the way it is described inside the system prompt.
We will see how this all comes together very soon.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</li>
<li>
<p>Now it&#8217;s time to call the LLM from our <code>HelloController</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">HelloController</span> {

    ...
    private <span style="color:#088;font-weight:bold">final</span> OllamaAiService ollamaAiService;

    <span style="color:#007">@GetMapping</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> sayHello(<span style="color:#007">@RequestParam</span> <span style="color:#0a8;font-weight:bold">String</span> name) {
        <span style="color:#777">//create and persist user</span>

        <span style="color:#0a8;font-weight:bold">String</span> lastName = ollamaAiService.call(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> <i class="conum" data-value="1"></i><b>(1)</b>
                You are a helpful assistant. You will be given a first name of a person.
                Your purpose is to invent the last name of that person and return it as a repsponse.
                For example:

                User: John
                AI: Smith

                User: Anne
                AI: Croft

                You should return only a string containing a single name.
                </span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>, name);

        <span style="color:#080;font-weight:bold">return</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello, %s %s!</span><span style="color:#710">&quot;</span></span>.formatted(user.getFirstName(), lastName);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As you can see we give a definite purpose to the LLM. We tell it what the input is going to be, and what we expect as output.
We also give it some samples, so it can better understand the task.
The more detailed your system prompt is, the more accurate the LLM will be in responding.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Completing this step concluded the set-up in this chapter.
Now if you call <code><a href="http://localhost:8080/hello?name=Jennie" class="bare">http://localhost:8080/hello?name=Jennie</a></code> for example, you should see a message like: <code>Hello, Jennie Reid!</code></p>
</div>
<div class="paragraph">
<p>Are you getting it now?
If so, then you gotta keep reading through the next chapters!
We are going to set up our database correctly and implement our aforementioned use cases to make our project complete.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_database">4. Setting up the database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have reached up to this part, then congratulations!
There&#8217;s no turning back now, you are going to finish this or be doomed of the unsettling feeling of incompleteness! üò±</p>
</div>
<div class="paragraph">
<p>But we all know that you are an achiever, and you will never let a book unfinished, right? RIGHT!</p>
</div>
<div class="paragraph">
<p>That&#8217;s what I also thought.
Now let&#8217;s delve into expanding our database, so it can handle all the LLM responses we throw at it.
To start off, we are heading a towards a model, that looks like this.</p>
</div>
<div class="sect2">
<h3 id="_the_full_database_in_a_diagram">4.1. The full database in a diagram</h3>
<div class="imageblock text-center">
<div class="content">
<img src="img/database.png" alt="database">
</div>
</div>
<div class="paragraph">
<p>I know.
Tables are a bit more than what we saw in the component diagram, but now we&#8217;re delving into the lower levels, where we
have to be precise if we want to get the best results.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_the_entities">4.2. Building the entities</h3>
<div class="imageblock text-center">
<div class="content">
<img src="img/what-are-we.png" alt="what are we">
</div>
<div class="title">Figure 2. This image was totally "not" generated by AI.</div>
</div>
<div class="paragraph">
<p>Let&#8217;s get started!</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Extend the user model</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Getter</span>
<span style="color:#007">@Setter</span>
<span style="color:#007">@NoArgsConstructor</span>
<span style="color:#007">@Entity</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">users</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">User</span> {

    <span style="color:#007">@Id</span>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> id;

    <span style="color:#007">@Version</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> version;

    <span style="color:#088;font-weight:bold">public</span> User(<span style="color:#0a8;font-weight:bold">String</span> firstName) {
        <span style="color:#950">this</span>.firstName = firstName;
    }

    <span style="color:#088;font-weight:bold">public</span> User(<span style="color:#0a8;font-weight:bold">String</span> firstName, <span style="color:#0a8;font-weight:bold">String</span> lastName, <span style="color:#339;font-weight:bold">int</span> age, <span style="color:#339;font-weight:bold">int</span> height, <span style="color:#339;font-weight:bold">double</span> weight, Gender gender, <span style="color:#339;font-weight:bold">int</span> recommendedCal) {
        <span style="color:#950">this</span>.firstName = firstName;
        <span style="color:#950">this</span>.lastName = lastName;
        <span style="color:#950">this</span>.age = age;
        <span style="color:#950">this</span>.height = height;
        <span style="color:#950">this</span>.weight = weight;
        <span style="color:#950">this</span>.gender = gender;
        <span style="color:#950">this</span>.recommendedCal = recommendedCal;
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> firstName;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> lastName;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> age;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> height;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">double</span> weight;

    <span style="color:#007">@Enumerated</span>(EnumType.STRING)
    <span style="color:#088;font-weight:bold">private</span> Gender gender;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">int</span> recommendedCal;
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
This might break your current database.
I recommend you to delete all existing tables and let Hibernate generate new ones.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In adition we also need to introduce implementation for the <code>Gender</code> enum:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">enum</span> Gender {
    MALE, FEMALE
}</code></pre>
</div>
</div>
</li>
<li>
<p>Next step is to add our <code>Meal</code> entity. It will store the information of all the meals the user has eaten.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Entity</span>
<span style="color:#007">@Getter</span>
<span style="color:#007">@Setter</span>
<span style="color:#007">@NoArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Meal</span> {

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> DEFAULT_REVIEW_VALUE = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Computing...</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#007">@Id</span>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> id;

    <span style="color:#007">@Version</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> version;

    <span style="color:#007">@ManyToMany</span>(cascade = {
            CascadeType.MERGE,
            CascadeType.PERSIST
    })
    <span style="color:#007">@JoinTable</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">meal_consummed_foods</span><span style="color:#710">&quot;</span></span>,
            joinColumns = <span style="color:#007">@JoinColumn</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">food_id</span><span style="color:#710">&quot;</span></span>),
            inverseJoinColumns = <span style="color:#007">@JoinColumn</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">amount_id</span><span style="color:#710">&quot;</span></span>))
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;FoodItemAmount&gt; consumedFoods; <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">private</span> ZonedDateTime timestamp;

    <span style="color:#007">@ManyToOne</span>
    <span style="color:#088;font-weight:bold">private</span> User user;

    <span style="color:#007">@Column</span>(columnDefinition = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">TEXT</span><span style="color:#710">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> review = DEFAULT_REVIEW_VALUE; <i class="conum" data-value="3"></i><b>(3)</b>

    <span style="color:#088;font-weight:bold">public</span> Meal(User user, <span style="color:#0a8;font-weight:bold">Set</span>&lt;FoodItemAmount&gt; consumedFoods, ZonedDateTime timestamp) {
        <span style="color:#950">this</span>.user = user;
        <span style="color:#950">this</span>.consumedFoods = consumedFoods;
        <span style="color:#950">this</span>.timestamp = timestamp;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We want the consumed foods to be shared by all users, so that when a new user enters the same food and amount,
we can find it in our database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The review might be more than 255 characters, so we need to make the space for that column in the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We initialize the review with this value, as the content is going to be generated by the LLM in a later stage</td>
</tr>
</table>
</div>
</li>
<li>
<p>Our next entity will be the <code>FoodItem</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Entity</span>
<span style="color:#007">@Getter</span>
<span style="color:#007">@Setter</span>
<span style="color:#007">@NoArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">FoodItem</span> {

    <span style="color:#007">@Id</span>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> id;

    <span style="color:#007">@Version</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> version;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> name;

    <span style="color:#007">@ManyToMany</span>(cascade = {
            CascadeType.MERGE,
            CascadeType.PERSIST
    })
    <span style="color:#007">@JoinTable</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">food_item_nutrient</span><span style="color:#710">&quot;</span></span>,
            joinColumns = <span style="color:#007">@JoinColumn</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">food_id</span><span style="color:#710">&quot;</span></span>),
            inverseJoinColumns = <span style="color:#007">@JoinColumn</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nutrient_id</span><span style="color:#710">&quot;</span></span>))
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Nutrient&gt; nutrients = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashSet</span>&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span style="color:#088;font-weight:bold">public</span> FoodItem(<span style="color:#0a8;font-weight:bold">String</span> name) {
        <span style="color:#950">this</span>.name = name;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To prevent redundancy we are going to link the nutrients with the food items just like we did to the meal and the food amounts</td>
</tr>
</table>
</div>
</li>
<li>
<p>The <code>Nutrient</code> table should look like so:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Entity</span>
<span style="color:#007">@Getter</span>
<span style="color:#007">@Setter</span>
<span style="color:#007">@NoArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Nutrient</span> {
    <span style="color:#007">@Id</span>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> id;

    <span style="color:#007">@Version</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> version;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> name;

    <span style="color:#007">@ManyToMany</span>(mappedBy = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nutrients</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;FoodItem&gt; foods;

    <span style="color:#088;font-weight:bold">public</span> Nutrient(<span style="color:#0a8;font-weight:bold">String</span> name) {
        <span style="color:#950">this</span>.name = name;
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>And finally our last table <code>FoodItemAmount</code> should take the following form</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Entity</span>
<span style="color:#007">@Getter</span>
<span style="color:#007">@Setter</span>
<span style="color:#007">@NoArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">FoodItemAmount</span> {
    <span style="color:#007">@Id</span>
    <span style="color:#007">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> id;

    <span style="color:#007">@Version</span>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">long</span> version;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">double</span> amount;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> unit;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Integer</span> calories;

    <span style="color:#007">@ManyToOne</span>
    <span style="color:#088;font-weight:bold">private</span> FoodItem foodItem;

    <span style="color:#007">@ManyToMany</span>(mappedBy = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">consumedFoods</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;Meal&gt; meal;

    <span style="color:#088;font-weight:bold">public</span> FoodItemAmount(FoodItem foodItem, <span style="color:#339;font-weight:bold">double</span> amount, <span style="color:#0a8;font-weight:bold">String</span> unit) {
        <span style="color:#950">this</span>.foodItem = foodItem;
        <span style="color:#950">this</span>.amount = amount;
        <span style="color:#950">this</span>.unit = unit;
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>And that&#8217;s it!
You can be creative and think of a better model or even extend it to have more data, but to keep this workshop quick and easy,
we will stick only to these models.
Now I&#8217;ll live up to you to generate the repositories for each entity.
By now, you should be able to figure out how it&#8217;s done.
After you&#8217;re done, we can move to the next chapter to set up our endpoints.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To avoid copy-pasting <code>id</code> and <code>version</code> every time, maybe consider putting them in an abstract class?
Why didn&#8217;t I think of such an idea&#8230;&#8203; ü§Ø
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_endpoints">5. Setting up the endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Concluding this part, means that you are half way there! Where? To the place where you have a functional application, of course.
We need to start filling up that database, and the way to do it is by setting up some endpoints to take in our data.
Let&#8217;s hop on and do this!</p>
</div>
<div class="sect2">
<h3 id="_usercontroller">5.1. <code>UserController</code></h3>
<div class="paragraph">
<p>This is the initial endpoint users encounter when creating an account in our application.
They are prompted to input their physical metrics, allowing the app to personalize their experience.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the DTO folder, create a new record, called <code>UserDTO</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@JsonInclude</span>(JsonInclude.Include.NON_NULL) <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#088;font-weight:bold">public</span> record UserDTO(<span style="color:#0a8;font-weight:bold">Long</span> id, <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#0a8;font-weight:bold">String</span> firstName, <span style="color:#0a8;font-weight:bold">String</span> lastName, <span style="color:#339;font-weight:bold">int</span> age, <span style="color:#339;font-weight:bold">int</span> height, <span style="color:#339;font-weight:bold">double</span> weight, Gender gender, <span style="color:#339;font-weight:bold">int</span> recommendedCal) {

    <span style="color:#088;font-weight:bold">public</span> UserDTO(User user) {
        <span style="color:#950">this</span>(user.getId(), user.getFirstName(), user.getLastName(), user.getAge(),
                user.getHeight(), user.getWeight(), user.getGender(), user.getRecommendedCal());
    }

    <span style="color:#088;font-weight:bold">public</span> User toUser() {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">new</span> User(firstName, lastName, age, height, weight, gender, recommendedCal);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adding this annotation stops null values from showing in the JSON.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use the id for the responses. When we create users, we don&#8217;t need to pass it.
The database will generate it automatically for us.
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To keep the project minimal we are adding a constructor to convert the entity to DTO and a method to convert the DTO to entity.
You can feel free to use libraries like MapStruct, if you want to avoid repeating these methods for every DTO we make.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
</li>
<li>
<p>Next step is to implement our <code>UserController</code> class.
Similarly to our <code>HelloController</code>, we are going to make this class in the <code>controller</code> package.
Speaking of the <code>HelloController</code>, we don&#8217;t need it anymore. Feel free to remove it.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span>
<span style="color:#007">@AllArgsConstructor</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/user</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">UserController</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> UserRepository userRepository;

    <span style="color:#007">@PostMapping</span>
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;UserDTO&gt; createUser(<span style="color:#007">@RequestBody</span> UserDTO userDTO) {
        User user = userDTO.toUser();
        user = userRepository.save(user);
        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(<span style="color:#080;font-weight:bold">new</span> UserDTO(user));
    }

    <span style="color:#007">@GetMapping</span>
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;<span style="color:#0a8;font-weight:bold">List</span>&lt;UserDTO&gt;&gt; listAllUsers() {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;UserDTO&gt; users = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (User user : userRepository.findAll()) {
            users.add(<span style="color:#080;font-weight:bold">new</span> UserDTO(user));
        }

        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(users);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, let&#8217;s test that our endpoints are working properly.
Create a couple of users. You can use a tool like Postman, or a curl similar to the example here:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl --location 'localhost:8080/user' \
--header 'Content-Type: application/json' \
--data '{
    &quot;firstName&quot;: &quot;Cave&quot;,
    &quot;lastName&quot;: &quot;Johnson&quot;,
    &quot;age&quot;: 25,
    &quot;height&quot;: 170,
    &quot;weight&quot;: 75.3,
    &quot;gender&quot;: &quot;MALE&quot;,
    &quot;recommendedCal&quot;: 2500
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response should contain a JSON with the same object, along with the new user&#8217;s id:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>firstName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cave</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>lastName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Johnson</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>age</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">25</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>height</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">170</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>weight</span><span style="color:#404">&quot;</span></span>: <span style="color:#60E">75.3</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>gender</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">MALE</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>recommendedCal</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">2500</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And to list all the users, you simply make a GET request to that same endpoint</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl --location 'localhost:8080/user'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see a list of users as a response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
    {
        <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1</span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>firstName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cave</span><span style="color:#710">&quot;</span></span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>lastName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Johnson</span><span style="color:#710">&quot;</span></span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>age</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">25</span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>height</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">170</span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>weight</span><span style="color:#404">&quot;</span></span>: <span style="color:#60E">75.3</span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>gender</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">MALE</span><span style="color:#710">&quot;</span></span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>recommendedCal</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">2500</span>
    },
    {
        <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">2</span>,
        <span style="color:#F00;background-color:#FAA">.</span><span style="color:#F00;background-color:#FAA">.</span><span style="color:#F00;background-color:#FAA">.</span>
    },
    {
        <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">3</span>,
        <span style="color:#F00;background-color:#FAA">.</span><span style="color:#F00;background-color:#FAA">.</span><span style="color:#F00;background-color:#FAA">.</span>
    },
]</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_mealcontroller">5.2. <code>MealController</code></h3>
<div class="paragraph">
<p>The meal controller will be the next stop where our users will interact with the application.
Here they will enter their daily meals, and allow the application to analyze them.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create <code>FoodItemAmountDTO</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@JsonInclude</span>(JsonInclude.Include.NON_NULL)
<span style="color:#088;font-weight:bold">public</span> record FoodItemAmountDTO(<span style="color:#0a8;font-weight:bold">String</span> foodName, <span style="color:#339;font-weight:bold">double</span> amount, <span style="color:#0a8;font-weight:bold">String</span> unit, <span style="color:#0a8;font-weight:bold">Integer</span> calories) {

    <span style="color:#088;font-weight:bold">public</span> FoodItemAmountDTO(FoodItemAmount foodItemAmount) {
        <span style="color:#950">this</span>(foodItemAmount.getFoodItem().getName(), foodItemAmount.getAmount(),
                foodItemAmount.getUnit(), foodItemAmount.getCalories());
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>MealDTO</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@JsonInclude</span>(JsonInclude.Include.NON_NULL)
<span style="color:#088;font-weight:bold">public</span> record MealDTO(<span style="color:#339;font-weight:bold">long</span> id, <span style="color:#339;font-weight:bold">long</span> userId, <span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemAmountDTO&gt; consumedFoods,
                      <span style="color:#339;font-weight:bold">long</span> timestamp, <span style="color:#0a8;font-weight:bold">String</span> review) {

    <span style="color:#088;font-weight:bold">public</span> MealDto(Meal meal) {
        <span style="color:#950">this</span>(meal.getId(), meal.getUser().getId(),
                meal.getConsumedFoods().stream().map(FoodItemAmountDTO::<span style="color:#080;font-weight:bold">new</span>).toList(),
                meal.getTimestamp().toInstant().toEpochMilli(), meal.getReview());
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Now it&#8217;s time to extend our repositories in order to be able to obtain some data.
Just bear with me, it will all make sense in the end.</p>
<div class="ulist">
<ul>
<li>
<p>Add a <code>findByName()</code> method in your <code>FoodItem</code> repository</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Repository</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">FoodItemRepository</span> <span style="color:#088;font-weight:bold">extends</span> CrudRepository&lt;FoodItem, <span style="color:#0a8;font-weight:bold">Long</span>&gt; {
    Optional&lt;FoodItem&gt; findByName(<span style="color:#0a8;font-weight:bold">String</span> name);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add a <code>findByFoodAmountAndUnit()</code> method in your <code>FoodItemAmount</code> repository</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Repository</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">FoodItemAmountRepository</span> <span style="color:#088;font-weight:bold">extends</span> CrudRepository&lt;FoodItemAmount, <span style="color:#0a8;font-weight:bold">Long</span>&gt; {
    Optional&lt;FoodItemAmount&gt; findByFoodAmountAndUnit(FoodItem foodItem, <span style="color:#339;font-weight:bold">double</span> amount, <span style="color:#0a8;font-weight:bold">String</span> unit);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will also need to create a named query in <code>FoodItemAmount</code> in order for this method to work</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@NamedQuery</span>(name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">FoodItemAmount.findByFoodAmountAndUnit</span><span style="color:#710">&quot;</span></span>,
        query = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">select fia from FoodItemAmount fia where fia.foodItem = ?1 and fia.amount = ?2 and fia.unit = ?3</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">FoodItemAmount</span> {...}</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, add a <code>findAllByUser()</code> method in your <code>Meal</code> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Repository</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">interface</span> <span style="color:#B06;font-weight:bold">MealRepository</span> <span style="color:#088;font-weight:bold">extends</span> CrudRepository&lt;Meal, <span style="color:#0a8;font-weight:bold">Long</span>&gt; {
    <span style="color:#0a8;font-weight:bold">List</span>&lt;Meal&gt; findAllByUser(User user);
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Now it&#8217;s time to implement the controller:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span>
<span style="color:#007">@AllArgsConstructor</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/meal</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MealController</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> FoodItemRepository foodItemRepository;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> FoodItemAmountRepository foodItemAmountRepository;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> MealRepository mealRepository;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> UserRepository userRepository;

    <span style="color:#007">@PostMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/user/{id}</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;MealDto&gt; createMeal(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">Long</span> userId, <span style="color:#007">@RequestBody</span> MealDto mealDto) {
        User user = userRepository.findById(userId).orElse(<span style="color:#069">null</span>);
        <span style="color:#080;font-weight:bold">if</span> (user == <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">return</span> ResponseEntity.notFound().build();
        }

        ZonedDateTime timestamp = Instant.ofEpochMilli(mealDto.timestamp()).atZone(UTC);
        <span style="color:#0a8;font-weight:bold">Set</span>&lt;FoodItemAmount&gt; foodItemAmounts = obtainFoodItemAmounts(mealDto.consumedFoods());
        Meal meal = <span style="color:#080;font-weight:bold">new</span> Meal(user, foodItemAmounts, timestamp);
        mealRepository.save(meal);
        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(<span style="color:#080;font-weight:bold">new</span> MealDto(meal));
    }

    <span style="color:#007">@GetMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/user/{id}</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;<span style="color:#0a8;font-weight:bold">List</span>&lt;MealDto&gt;&gt; listAllUserMeals(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">Long</span> userId) {
        User user = userRepository.findById(userId).orElse(<span style="color:#069">null</span>);
        <span style="color:#080;font-weight:bold">if</span> (user == <span style="color:#069">null</span>) {
            <span style="color:#080;font-weight:bold">return</span> ResponseEntity.notFound().build();
        }

        <span style="color:#0a8;font-weight:bold">List</span>&lt;MealDto&gt; meals = mealRepository.findAllByUser(user)
                .stream().map(MealDto::<span style="color:#080;font-weight:bold">new</span>).toList();

        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(meals);
    }

    <span style="color:#007">@GetMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/{id}</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;MealDto&gt; getMealById(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">Long</span> mealId) {
        <span style="color:#080;font-weight:bold">return</span> mealRepository.findById(mealId)
                .map(MealDto::<span style="color:#080;font-weight:bold">new</span>)
                .map(ResponseEntity::ok)
                .orElseGet(() -&gt; ResponseEntity.notFound().build());
    }


    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Set</span>&lt;FoodItemAmount&gt; obtainFoodItemAmounts(<span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemAmountDTO&gt; dtos) {
        <span style="color:#0a8;font-weight:bold">Set</span>&lt;FoodItemAmount&gt; foodItemAmounts = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashSet</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> dto : dtos) {
            FoodItem foodItem = foodItemRepository.findByName(dto.foodName())
                    .orElseGet(() -&gt; foodItemRepository.save(<span style="color:#080;font-weight:bold">new</span> FoodItem(dto.foodName())));

            FoodItemAmount fia = foodItemAmountRepository.findByFoodAmountAndUnit(foodItem, dto.amount(), dto.unit())
                    .orElseGet(() -&gt; foodItemAmountRepository.save(<span style="color:#080;font-weight:bold">new</span> FoodItemAmount(foodItem, dto.amount(), dto.unit())));

            foodItemAmounts.add(fia);
        }

        <span style="color:#080;font-weight:bold">return</span> foodItemAmounts;
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>When you&#8217;re done, you can test the endpoint with the following payload:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span style="color:#606"><span style="color:#404">&quot;</span><span>timestamp</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1744831242595</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>consumedFoods</span><span style="color:#404">&quot;</span></span>: [
        {
            <span style="color:#606"><span style="color:#404">&quot;</span><span>foodName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Bread</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>amount</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">500</span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>unit</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">gr</span><span style="color:#710">&quot;</span></span>
        },
        {
            <span style="color:#606"><span style="color:#404">&quot;</span><span>foodName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Yogurt</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>amount</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">400</span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>unit</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">gr</span><span style="color:#710">&quot;</span></span>
        },
        {
            <span style="color:#606"><span style="color:#404">&quot;</span><span>foodName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cheese</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>amount</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">3</span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>unit</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">slices</span><span style="color:#710">&quot;</span></span>
        }
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And your response should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>userId</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>consumedFoods</span><span style="color:#404">&quot;</span></span>: [
        {
            <span style="color:#606"><span style="color:#404">&quot;</span><span>foodName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Bread</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>amount</span><span style="color:#404">&quot;</span></span>: <span style="color:#60E">500.0</span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>unit</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">gr</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>calories</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">0</span>
        },
        {
            <span style="color:#606"><span style="color:#404">&quot;</span><span>foodName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Yogurt</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>amount</span><span style="color:#404">&quot;</span></span>: <span style="color:#60E">400.0</span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>unit</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">gr</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>calories</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">0</span>
        },
        {
            <span style="color:#606"><span style="color:#404">&quot;</span><span>foodName</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cheese</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>amount</span><span style="color:#404">&quot;</span></span>: <span style="color:#60E">3.0</span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>unit</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">slices</span><span style="color:#710">&quot;</span></span>,
            <span style="color:#606"><span style="color:#404">&quot;</span><span>calories</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">0</span>
        }
    ],
    <span style="color:#606"><span style="color:#404">&quot;</span><span>timestamp</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">1744831242595</span>,
    <span style="color:#606"><span style="color:#404">&quot;</span><span>review</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Computing...</span><span style="color:#710">&quot;</span></span>
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_the_fooditemcontroller">5.3. The <code>FoodItemController</code></h3>
<div class="paragraph">
<p>Finally, to wrap the series of controllers we need one last controller, that will allow the user to browse the collected
knowledge of food our application has gathered, through user input and LLM.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a record, named <code>FoodItemDTO</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@JsonInclude</span>(JsonInclude.Include.NON_NULL)
<span style="color:#088;font-weight:bold">public</span> record FoodItemDTO(<span style="color:#339;font-weight:bold">long</span> id, <span style="color:#0a8;font-weight:bold">String</span> name, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; nutrients) {

    <span style="color:#088;font-weight:bold">public</span> FoodItemDTO(<span style="color:#339;font-weight:bold">long</span> id, <span style="color:#0a8;font-weight:bold">String</span> name) {
        <span style="color:#950">this</span>(id, name, <span style="color:#069">null</span>);
    }

    <span style="color:#088;font-weight:bold">public</span> FoodItemDTO(FoodItem foodItem) {
        <span style="color:#950">this</span>(foodItem.getId(), foodItem.getName(),
                foodItem.getNutrients().stream().map(Nutrient::getName).toList());
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>Create <code>FoodItemController</code></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span>
<span style="color:#007">@AllArgsConstructor</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/food</span><span style="color:#710">&quot;</span></span>)
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">FoodItemController</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> FoodItemRepository foodItemRepository;

    <span style="color:#007">@GetMapping</span>
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;<span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemDTO&gt;&gt; listAllFoodItems() {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemDTO&gt; foodItems = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> foodItem : foodItemRepository.findAll()) {
            FoodItemDTO dto = <span style="color:#080;font-weight:bold">new</span> FoodItemDTO(foodItem.getId(), foodItem.getName());
            foodItems.add(dto);
        }

        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(foodItems);
    }

    <span style="color:#007">@GetMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/search</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;<span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemDTO&gt;&gt; getByNameOrId(<span style="color:#007">@RequestParam</span>(required = <span style="color:#069">false</span>, defaultValue = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">0</span><span style="color:#710">&quot;</span></span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">Long</span> id,
                                                           <span style="color:#007">@RequestParam</span>(required = <span style="color:#069">false</span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">name</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">String</span> name) {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemDTO&gt; results = Stream.of(foodItemRepository.findById(id), foodItemRepository.findByName(name))
                .filter(Optional::isPresent)
                .map(Optional::get)
                .map(FoodItemDTO::<span style="color:#080;font-weight:bold">new</span>)
                .toList();

        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(results);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Now test all endpoints respectively.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you have completed this part, then congratulations! üéâ
You have reached the doorstep to the usage of LLM.
Follow along to the next chapter where we are going to use the user data to query the LLM, gather food information and
create meal reviews, that are going to allow the user make better eating choices next time they want to enter something.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_data_with_llm">6. Generating data with LLM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have finally reached the part where the magic happens!
In this section we are going to take the data we collected form the user and task our local AI to generate useful data
that is going to be presented to the user when they demand it.
Generally the user would be interested how did the meal impact their nutrition and what are the nutritional values of the foods they eat.
The series of data generators we are going to create here are also intended to make the interaction with the LLM seamless, meaning that throughout the usage of application, the end user will not be aware that an LLM runs under the hood. üòé
<br>
Now, without further ado, let&#8217;s see how we can incorporate our LLM integration to do this for us.</p>
</div>
<div class="paragraph">
<p>The first part is to create proper service classes that are going to give our LLM different tasks, based on the purpose
it is meant to do.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">But, before we begin</div>
<div class="paragraph">
<p>During this section, you might ask yourself: why not create an all-in-one AI prompt? ü§î
While it would be ideal to provide AI with a single prompt for comprehensive analysis, the more diverse the input we include,
the more varied and potentially unfocused the responses become.
That&#8217;s why we want to concentrate on a single task at a time.</p>
</div>
<div class="paragraph">
<p>Based on the content of the system prompt, the LLM will generate a unique output, meaning that every
single word matters.
I embrace you to try different prompts and see what outcomes you will get.
Maybe your results might be better than the ones we shall observe in this workshop.</p>
</div>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Take it with a grain of salt!</div>
<div class="ulist">
<ul>
<li>
<p>Please keep in mind that all the data generated by the LLM model is artificial and in most cases inaccurate!</p>
</li>
<li>
<p>llama 3.2 does not have access to the internet, neither is trained to give accurate food advices.</p>
</li>
<li>
<p>Remember that we use it only to prove the possibility to utilize an LLM model for these tasks.</p>
</li>
<li>
<p>In the real world scenario you would need to specifically train your LLM with the data it needs to be sufficient nutrition
adviser.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_the_nutrientgenerator_our_first_llm_generator">6.1. The <code>NutrientGenerator</code>, our first LLM generator</h3>
<div class="paragraph">
<p>The nutrient generator&#8217;s task is to create nutrient data for our foods.
If you remember we did not do anything for the Nutrient entity in our previous chapters.
This is the place where we are finally going to do something about it.
Inside your <code>ai</code> package, create a class called <code>NutrientGenerator</code> and add let&#8217;s start implementing!</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First we can define the outlines of our class.
We want to annotate it as a <code>@Service</code> and import our dependencies.
We can also define our method that is going to communicate with the rest of our services:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutrientGenerator</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OllamaAiService ollamaAiService;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItem, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; obtainNutrientData(<span style="color:#0a8;font-weight:bold">Collection</span>&lt;FoodItem&gt; foodItems) {
        ...
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>The next step is to define our prompt.
This is where we are going to shape the data that is unique to the food items we are going to pass to the LLM.
We are also going to tell the LLM what format it should give us response in, so we can parse it properly afterward.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutrientGenerator</span> {

    <span style="color:#777">// definitions...</span>

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> PROMPT = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
            You're a helpful assistant. You are going to be given a list of foods.
            In return you have to respond with a json formatted list of the nutrients associated with that food.
            For example:
            ----
            User: Banana, Pistachio, Cheese
            AI: [
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span>Banana<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>nutrients<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: [</span><span style="color:#710">&quot;</span></span>Vitamin C<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin B6<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Fiber<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Potassium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Protein<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Magnesium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Manganese<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Saturated fat<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">]
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span>Pistachio<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>nutrients<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: [</span><span style="color:#710">&quot;</span></span>Dietary fiber<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Protein<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>G carbohydrate<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin B6<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Copper<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Iron<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Magnesium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Phosphorus<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Manganese<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">]
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span>Cheese<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>nutrients<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: [</span><span style="color:#710">&quot;</span></span>Calcium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin B12<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Phosphorus<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Sodium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin A<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Phosphorus<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Potassium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">]
                    }
            ]

            ----

            Do not limit yourself to the list given above. Answer with as many nutrients as you know. If you don't recognize the food item, set the nutrients value to null.


            For example:
            ----
            User: Banana, Facebook, Cheese
            AI: [
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span>Banana<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>nutrients<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: [</span><span style="color:#710">&quot;</span></span>Vitamin C<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin B6<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Fiber<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Potassium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Protein<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Magnesium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Manganese<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Saturated fat<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">]
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span>Facebook<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>nutrients<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: null
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span>Cheese<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>nutrients<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: [</span><span style="color:#710">&quot;</span></span>Calcium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin B12<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Phosphorus<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Sodium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Vitamin A<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Phosphorus<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>Potassium<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">]
                    }
            ]
            ----

            Please answer only in the format shown in </span><span style="color:#710">&quot;</span></span>----<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">. Do not add anything else to your answer.
            </span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#777">// implementations...</span>
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The prompt should be consistent and exact.
You need to specify exactly what you want the LLM to do, otherwise the results might not be predictable.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Finally, we are going to implement the <code>obtainNutrientData</code> method, where the real work happens:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutrientGenerator</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> PROMPT = ...;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OllamaAiService ollamaAiService;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItem, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; obtainNutrientData(<span style="color:#0a8;font-weight:bold">Collection</span>&lt;FoodItem&gt; foodItems) {
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, FoodItem&gt; reverseMap = foodItems.stream().collect(Collectors.toMap(FoodItem::getName, fi -&gt; fi));

        <span style="color:#0a8;font-weight:bold">String</span> foodList = <span style="color:#0a8;font-weight:bold">String</span>.join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>, reverseMap.keySet());
        <span style="color:#0a8;font-weight:bold">String</span> aiOutput = ollamaAiService.call(PROMPT, foodList);

        <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItem, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; result = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">try</span> {
            FoodItemNutrients<span style="color:#339;font-weight:bold">[]</span> foodNutrientResult = JsonUtils.toObject(aiOutput, FoodItemNutrients<span style="color:#339;font-weight:bold">[]</span>.class); <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> item : foodNutrientResult) {
                FoodItem foodItem = reverseMap.get(item.name);
                result.putIfAbsent(foodItem, item.nutrients);
            }

            <span style="color:#080;font-weight:bold">return</span> result;
        } <span style="color:#080;font-weight:bold">catch</span> (JsonProcessingException jpe) {
            <span style="color:#777">//handle the exception</span>
        }
    }

    record FoodItemNutrients(<span style="color:#0a8;font-weight:bold">String</span> name, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; nutrients) { } <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>JsonUtils</code> class is a helper class definded by us to help us to seamlessly serialize and deserialize JSON strings into Java objects.
Read further to find out more.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>FoodItemNutrients</code> is not mandatory, but it will help us turn the LLM output into usable Java objects.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Throughout the implementation of the generators, we are not going to produce or modify any of the entities.
This is a task that should be performed elsewhere, as we might need to validate the data or do something else with it,
before we persist it.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Defining the <code>JsonUtils</code> class</div>
<div class="paragraph">
<p>As previously mentioned, the <code>JsonUtils</code> class is used to wrap the invocations of the jackson converters.
You can define your <code>JusonUtils</code> class in the <code>utils</code> package like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">JsonUtils</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> ObjectMapper OBJECT_MAPPER = <span style="color:#080;font-weight:bold">new</span> ObjectMapper();

    <span style="color:#088;font-weight:bold">private</span> JsonUtils() {

    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> &lt;T&gt; T toObject(<span style="color:#0a8;font-weight:bold">String</span> json, <span style="color:#0a8;font-weight:bold">Class</span>&lt;T&gt; clazz) <span style="color:#088;font-weight:bold">throws</span> JsonProcessingException {
        <span style="color:#080;font-weight:bold">return</span> OBJECT_MAPPER.readValue(json, clazz);
    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#088;font-weight:bold">static</span> &lt;T&gt; <span style="color:#0a8;font-weight:bold">String</span> toJson(T object) <span style="color:#088;font-weight:bold">throws</span> JsonProcessingException {
        <span style="color:#080;font-weight:bold">return</span> OBJECT_MAPPER.writeValueAsString(object);
    }

}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we want to test if our generator works properly.
To do so, we have to connect it to our meal controller.</p>
</div>
<div class="paragraph">
<p>In the <code>ai</code> package create another class, called <code>NutritionAdviserService</code>.
This will be our single entrypoint to the LLM generators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutritionAdviserService</span> {

    <span style="color:#007">@EventListener</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> obtainMealDataFromLLM(MealCreatedEvent event) { <i class="conum" data-value="2"></i><b>(2)</b>

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We want this class to handle application events, as we are going to call this after the creation of the meal,
but not invoke it directly into the controller.
This design allows us to add different event handlers in the future, where we can trigger separate tasks
and not mix everything into one single service.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The event payload needs specific implementation in order to be injected into the method.
You can implement it like this:
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Getter</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MealCreatedEvent</span> <span style="color:#088;font-weight:bold">extends</span> ApplicationEvent {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> Meal meal;

    <span style="color:#088;font-weight:bold">public</span> MealCreatedEvent(Meal meal, <span style="color:#0a8;font-weight:bold">Object</span> source) {
        <span style="color:#950">super</span>(source);
        <span style="color:#950">this</span>.meal = meal;
    }
}</code></pre>
</div>
</div></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next step is to implement logic for invoking the Nutrient generator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutritionAdviserService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> NutrientGenerator nutrientGenerator;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> FoodItemRepository foodItemRepository;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> NutrientRepository nutrientRepository;

    <span style="color:#007">@EventListener</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> obtainMealDataFromLLM(MealCreatedEvent event) {
        Meal meal = event.getMeal();
        obtainNutrientData(meal);
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> obtainNutrientData(Meal meal) {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItem&gt; foodItemsWithoutNutrients = meal.getConsumedFoods().stream()
                .map(FoodItemAmount::getFoodItem)
                .filter(foodItem -&gt; foodItem.getNutrients().isEmpty()).toList();

        <span style="color:#080;font-weight:bold">if</span> (foodItemsWithoutNutrients.isEmpty()) { <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#080;font-weight:bold">return</span>;
        }

        <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItem, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt;&gt; foodNutrients = nutrientGenerator.obtainNutrientData(foodItemsWithoutNutrients);

        <span style="color:#777">//Finding or creating new nutrient entries, to avoid duplication in the database</span>
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Nutrient&gt; nutrientMap = computeNutrientMap(foodNutrients.values()
                .stream().flatMap(<span style="color:#0a8;font-weight:bold">List</span>::stream).collect(Collectors.toSet()));

        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> entry : foodNutrients.entrySet()) {
            FoodItem foodItem = entry.getKey();
            <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; generatedNutrients = entry.getValue();
            <span style="color:#080;font-weight:bold">if</span> (generatedNutrients != <span style="color:#069">null</span>) {
                <span style="color:#0a8;font-weight:bold">List</span>&lt;Nutrient&gt; nutrients = generatedNutrients.stream().map(nutrientMap::get).toList();
                foodItem.getNutrients().addAll(nutrients);
                foodItemRepository.save(foodItem);
            }
        }
    }
}

 <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Nutrient&gt; computeNutrientMap(<span style="color:#0a8;font-weight:bold">Set</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; nutrientNames) {
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, Nutrient&gt; nutrientMap = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> name : nutrientNames) {
            Nutrient nutrient = nutrientRepository.findByName(name)
                    .orElseGet(() -&gt; nutrientRepository.save(<span style="color:#080;font-weight:bold">new</span> Nutrient(name)));
            nutrientMap.put(name, nutrient);
        }

        <span style="color:#080;font-weight:bold">return</span> nutrientMap;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code should be self-explanatory - we filter out the food items that already have nutritional data and leave only the
data that needs to be processed by the LLM.
Then after we get response from the LLM, we flatten the data to create unique <code>Nutrient</code> entities and avoid persisting ones that already exist.
Finally, we assign the list of nutrients to each food, found in the output list.</p>
</div>
<div class="paragraph">
<p>Now in order to call this event and trigger the logic, we need to go back to the <code>MealController</code> and add the event invocation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
public <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MealController</span> {
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> ApplicationEventPublisher event;

    ...

    <span style="color:#007">@PostMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/user/{id}</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;MealDto&gt; createMeal(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">Long</span> userId, <span style="color:#007">@RequestBody</span> MealDto mealDto) {
        ...

        event.publishEvent(<span style="color:#080;font-weight:bold">new</span> MealCreatedEvent(meal, <span style="color:#950">this</span>)); <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#080;font-weight:bold">return</span> ResponseEntity.ok(<span style="color:#080;font-weight:bold">new</span> MealDto(meal));
    }

    <span style="color:#088;font-weight:bold">public</span> ResponseEntity&lt;<span style="color:#0a8;font-weight:bold">List</span>&lt;MealDto&gt;&gt; listAllUserMeals(<span style="color:#007">@PathVariable</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">id</span><span style="color:#710">&quot;</span></span>) <span style="color:#0a8;font-weight:bold">Long</span> userId) {...}

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Put your event trigger right before sending the response</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now with this done, you can test the POST <code>/meal/user/{id}</code> endpoint again.
Your response might be delayed for up to a minute.
LLM is thinking!</p>
</div>
<div class="paragraph">
<p>Once you see a response from the service, you will not immediately see any nutrients.
This is because we have not programmed the DTO to show them.
But we have another endpoint for that.
Simply call GET <code>/food/search?name=&lt;foodName&gt;</code>, and check if the food has a list of nutrients assigned.
If you have implemented the classes properly, you should see a result like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[
  {
        <span style="color:#606"><span style="color:#404">&quot;</span><span>id</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">3</span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>name</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cheese</span><span style="color:#710">&quot;</span></span>,
        <span style="color:#606"><span style="color:#404">&quot;</span><span>nutrients</span><span style="color:#404">&quot;</span></span>: [
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Vitamin B12</span><span style="color:#710">&quot;</span></span>,
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Phosphorus</span><span style="color:#710">&quot;</span></span>,
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cholesterol</span><span style="color:#710">&quot;</span></span>,
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Vitamin A</span><span style="color:#710">&quot;</span></span>,
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Calcium</span><span style="color:#710">&quot;</span></span>,
            <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Sodium</span><span style="color:#710">&quot;</span></span>
        ]
    }
]</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Duude&#8230;&#8203; It&#8217;s so slow&#8230;&#8203;</div>
<div class="paragraph">
<p>From now on things, are going to get a little bit slower, I know.
Depending on how your machine is performing, you might experience slowdowns,
lags and thermal increases, but don&#8217;t worry and load that patience up!
We are going to mitigate this in the next chapter, by making those invocations asynchronous.</p>
</div>
<div class="paragraph">
<p>This won&#8217;t necessarily fix the computational speed, but at least it is going to improve the user experience
by avoiding the wait for AI computation.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_caloricinformationgenerator">6.2. <code>CaloricInformationGenerator</code></h3>
<div class="paragraph">
<p>The next thing we don&#8217;t have data for is how many calories does each <code>FoodItemAmount</code> have.
To be able to get that information, we will need to implement yet another LLM prompting class, called <code>CaloricInformationGemarator</code>
(or whatever better naming you have to offer&#8230;&#8203;)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">CaloricInformationGenerator</span> {

    record FoodCaloricImpact(<span style="color:#0a8;font-weight:bold">String</span> name, <span style="color:#339;font-weight:bold">int</span> calories) {
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> PROMPT = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
            You're a helpful assistant. You are going to be given a list of foods and their amounts.
            In return you have to respond with a json formatted list of the name of the food, its amount and its caloric impact, based on the amount given.
            For example:
            ----
            User: 500 gr Banana, 100 gr Pistachio, 1 slice Cheese
            AI: [
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">500</span> gr Banana<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>calories<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">445</span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">100</span> gr Pistachio<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>calories<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: 560
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">1</span> slice Cheese<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>calories<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: 40
                    }
            ]

            ----

            Do not limit yourself to the list given above. You may receive the same food item in different amounts.
            Give an answer for each ane every amount set. Calories will be integers only.
            If you don't recognize the food item, or the amount unit or size, set the caloric value to null.


            For example:
            ----
            User: 500 gr Banana, 100 gr Pistachio, 1 click Facebook
            AI: [
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">500</span> gr Banana<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>calories<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">445</span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">100</span> gr Pistachio<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>calories<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: 560
                    },
                    {
                        </span><span style="color:#710">&quot;</span></span>name<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">1</span> click Facebook<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                        </span><span style="color:#710">&quot;</span></span>calories<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: null
                    }
            ]
            ----

            Please answer only in the format shown in </span><span style="color:#710">&quot;</span></span>----<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">. Do not add anything else to your answer.
            </span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OllamaAiService ollamaAiService;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItemAmount, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; computeCaloricInformation(<span style="color:#0a8;font-weight:bold">Collection</span>&lt;FoodItemAmount&gt; foodItemAmounts) {
        <span style="color:#0a8;font-weight:bold">Map</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>, FoodItemAmount&gt; amountDataInput = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;&gt;();
        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> foodItemAmount : foodItemAmounts) {
            <span style="color:#0a8;font-weight:bold">String</span> listItem = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%f %s %s</span><span style="color:#710">&quot;</span></span>.formatted(foodItemAmount.getAmount(), foodItemAmount.getUnit(),
                    foodItemAmount.getFoodItem().getName());
            amountDataInput.put(listItem, foodItemAmount);
        }

        <span style="color:#0a8;font-weight:bold">String</span> inputList = <span style="color:#0a8;font-weight:bold">String</span>.join(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, </span><span style="color:#710">&quot;</span></span>, amountDataInput.keySet());
        <span style="color:#0a8;font-weight:bold">String</span> generatedResponse = ollamaAiService.call(PROMPT, inputList);
        <span style="color:#080;font-weight:bold">try</span> {
            FoodCaloricImpact<span style="color:#339;font-weight:bold">[]</span> parsedResults = JsonUtils.toObject(generatedResponse, FoodCaloricImpact<span style="color:#339;font-weight:bold">[]</span>.class);

            <span style="color:#777">//We don't want to implicitly set the data to the entity here. It should be done in a safe place where database</span>
            <span style="color:#777">//relations are managed.</span>
            <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItemAmount, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; computedCalories = <span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">HashMap</span>&lt;&gt;();
            <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> result : parsedResults) {
                FoodItemAmount foodItemAmount = amountDataInput.get(result.name);
                computedCalories.put(foodItemAmount, result.calories);
            }

            <span style="color:#080;font-weight:bold">return</span> computedCalories;
        } <span style="color:#080;font-weight:bold">catch</span> (JsonProcessingException jpe) {
            <span style="color:#777">//handle the exception</span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, we use a similar pattern, as it is proven to work with our previous prompter.
We will avoid doing anything to the data at this point and move onto the <code>NutritionAdviserService</code> where the processing will be done.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutritionAdviserService</span> {

    <span style="color:#777">//Don't forget to import CaloricInformationGenerator and FoodItemAmountRepository</span>
    ...
    <span style="color:#007">@EventListener</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> obtainMealDataFromLLM(MealCreatedEvent event) {
        ...
        obtainCaloricData(meal);
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#339;font-weight:bold">void</span> obtainCaloricData(Meal meal) {
        <span style="color:#0a8;font-weight:bold">List</span>&lt;FoodItemAmount&gt; foodAmountsWithoutCaloricData = meal.getConsumedFoods()
                .stream().filter(fia -&gt; fia.getCalories() == <span style="color:#069">null</span>).toList();

        <span style="color:#080;font-weight:bold">if</span> (foodAmountsWithoutCaloricData.isEmpty()) {
            <span style="color:#080;font-weight:bold">return</span>;
        }

        <span style="color:#0a8;font-weight:bold">Map</span>&lt;FoodItemAmount, <span style="color:#0a8;font-weight:bold">Integer</span>&gt; obtainedCaloricInformation = caloricInformationGenerator
                .computeCaloricInformation(foodAmountsWithoutCaloricData);

        <span style="color:#080;font-weight:bold">for</span> (<span style="color:#339;font-weight:bold">var</span> entry : obtainedCaloricInformation.entrySet()) {
            FoodItemAmount foodItemAmount = entry.getKey();
            foodItemAmount.setCalories(entry.getValue());
            foodItemAmountRepository.save(foodItemAmount);
        }
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once more we check only for the <code>FoodItemAmount</code> entities that don&#8217;t have computed caloric data
and task the LLM to generate that information for us.
You can go on and test again.
Currently, you should be able to see the generated data right into the response, but when we make this asunchronous,
we have to query our meal by id after a couple of minutes, to observe if any values got updated.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mealreviewgenerator">6.3. <code>MealReviewGenerator</code></h3>
<div class="paragraph">
<p>What is a nutrition adviser without the most important to the user piece of data?
The meal review - it is going to give the user some takeaways (no pun intended) of what the LLM thinks about the user&#8217;s meal.
To create that, let&#8217;s implement the <code>MealReviewGenerator</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MealReviewGenerator</span> {

    record MealAIInput(<span style="color:#339;font-weight:bold">int</span> age, <span style="color:#0a8;font-weight:bold">String</span> gender, <span style="color:#0a8;font-weight:bold">String</span> height, <span style="color:#0a8;font-weight:bold">String</span> weight, <span style="color:#339;font-weight:bold">int</span> dailyKcal, <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; meal) {
    }

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> PROMPT = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">
            You are a helpful assistant.
            You will receive a json object, containing information about a user, consisting of their age, gender, height, weight and recommended daily caloric intake.
            Inside that json you will get a list of food items this person ate on a single meal, along with the amounts of the food they ate.
            Your ultimate goal is to do a breakdown of that meal and advice the user whether this meal was ideal for them and whether it should be improved next time.

            Here is an example:
            ----
            User: {
                </span><span style="color:#710">&quot;</span></span>age<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: 15,
                </span><span style="color:#710">&quot;</span></span>gender<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: MALE,
                </span><span style="color:#710">&quot;</span></span>height<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#00D">165</span> cm<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                </span><span style="color:#710">&quot;</span></span>weight<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: </span><span style="color:#710">&quot;</span></span><span style="color:#60E">56.8</span> kg<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                </span><span style="color:#710">&quot;</span></span>dailyKcal<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: 2200,
                </span><span style="color:#710">&quot;</span></span>meal<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">: [
                    </span><span style="color:#710">&quot;</span></span><span style="color:#00D">100</span> gr banana<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                    </span><span style="color:#710">&quot;</span></span><span style="color:#00D">400</span> gr greek yogurt<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                    </span><span style="color:#710">&quot;</span></span><span style="color:#00D">100</span> gr bread<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                    </span><span style="color:#710">&quot;</span></span><span style="color:#00D">10</span> gr blueberries<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                    </span><span style="color:#710">&quot;</span></span><span style="color:#00D">10</span> gr peanut butter<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">,
                    </span><span style="color:#710">&quot;</span></span><span style="color:#00D">2</span> whole eggs<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">

                ]
            }

            AI:
            Your meal is well-balanced overall, especially for someone with a daily intake of 2200 kcal. Here's a breakdown of how it aligns with your nutritional needs:
            Pros:

                High Protein (83.6 g):
                    Excellent for muscle repair and growth, especially for a 15-year-old male in a growth phase. It covers ~38% of your daily protein needs (recommended ~1.2-2.0 g/kg of body weight).
                Good Balance of Carbs (92.3 g):
                    Provides quick energy for physical and mental activities. ~42% of the meal's calories come from carbs, which is within the acceptable range.
                Healthy Fats (33.5 g):
                    Includes healthy fats from peanut butter and eggs, supporting hormone production and overall health. Fat contributes ~30% of this meal‚Äôs calories, a good ratio.
                Micronutrients:
                    Banana: Rich in potassium.
                    Blueberries: Antioxidants for overall health.
                    Eggs: High in B vitamins, choline, and selenium.
                    Greek Yogurt: Calcium and probiotics for bone and gut health.

            Cons/Improvements:

                Low Fiber:
                    Only ~6-7 g of fiber in this meal (ideal daily target: ~25-30 g). Adding whole grains (like whole wheat bread) or more fruits/veggies would help.
                High Saturated Fat from Eggs and Peanut Butter:
                    Saturated fat is fine in moderation, but with 5 large eggs, it‚Äôs a bit high (~10 g). Reducing to 2-3 eggs or adding egg whites could lower saturated fat without compromising protein.
                Low Veggies:
                    No vegetables in the meal. Adding spinach, tomatoes, or bell peppers would boost vitamins A, C, and fiber.
                Sodium (Potentially High):
                    Depending on the bread and yogurt, sodium could be high. Opt for low-sodium options.

            Suggestions to Improve:

                Replace Some Eggs with Egg Whites:
                    Use 3 whole eggs + 2-3 egg whites to maintain protein but reduce calories and saturated fat.
                Swap Bread for Whole Grain/Seeded Bread:
                    Increases fiber and micronutrients like magnesium and zinc.
                Increase Vegetables:
                    Add 100-200 g of saut√©ed or fresh veggies (spinach, mushrooms, peppers) to the eggs.
                Include Healthy Fats:
                    Instead of peanut butter, try avocado for healthier monounsaturated fats.

            How Good Is This Meal?

            8/10: It‚Äôs an excellent high-protein, well-rounded meal, especially for a post-workout or breakfast. With small adjustments (e.g., more veggies, fiber, and balanced fats), it can become even healthier while maintaining its convenience and flavor!

            ----

            Please answer only in the format I gave you within the </span><span style="color:#710">&quot;</span></span>----<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">.
            </span><span style="color:#710">&quot;</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>;

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OllamaAiService ollamaAiService;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> generateMealAnalysis(Meal meal) {
        User user = meal.getUser();
        <span style="color:#0a8;font-weight:bold">String</span> height = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%d cm</span><span style="color:#710">&quot;</span></span>.formatted(user.getHeight());
        <span style="color:#0a8;font-weight:bold">String</span> weight = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%f kg</span><span style="color:#710">&quot;</span></span>.formatted(user.getWeight());
        <span style="color:#0a8;font-weight:bold">String</span> gender = user.getGender().toString();

        <span style="color:#0a8;font-weight:bold">List</span>&lt;<span style="color:#0a8;font-weight:bold">String</span>&gt; consumedFoods = meal.getConsumedFoods()
                .stream().map(fia -&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%f %s %s</span><span style="color:#710">&quot;</span></span>.formatted(fia.getAmount(), fia.getUnit(), fia.getFoodItem().getName()))
                .toList();

        MealAIInput aiInput = <span style="color:#080;font-weight:bold">new</span> MealAIInput(user.getAge(), gender, height, weight, user.getRecommendedCal(), consumedFoods);

        <span style="color:#080;font-weight:bold">try</span> {
            <span style="color:#0a8;font-weight:bold">String</span> userInput = JsonUtils.toJson(aiInput);

            <span style="color:#777">//We are not updating meal entity here, as we want to do it safely outside of this class.</span>
            <span style="color:#080;font-weight:bold">return</span> ollamaAiService.call(PROMPT, userInput);
        } <span style="color:#080;font-weight:bold">catch</span> (JsonProcessingException jpe) {
            <span style="color:#777">//process the exception</span>
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one is a bit longer for prompting and will take longer for the LLM to generate a response.
As we want more freely given information and ask the LLM for broader opinion, this will involve more time for it to "reason".</p>
</div>
<div class="paragraph">
<p>Finally, we are going to add invocation in our <code>NutritionAdviserService</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">NutritionAdviserService</span> {

    <span style="color:#777">//You know the drill already. Make sure your imports are consistent.</span>

    <span style="color:#007">@EventListener</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> obtainMealDataFromLLM(MealCreatedEvent event) {
        Meal meal = event.getMeal();
        obtainNutrientData(meal);
        obtainCaloricData(meal);
        obtainMealReview(meal); <span style="color:#777">//I am here</span>
    }

    ...

    private <span style="color:#339;font-weight:bold">void</span> obtainMealReview(Meal meal) {
        <span style="color:#080;font-weight:bold">if</span> (!meal.getReview().equals(Meal.DEFAULT_REVIEW_VALUE)) {
            <span style="color:#080;font-weight:bold">return</span>;
        }

        <span style="color:#0a8;font-weight:bold">String</span> review = mealReviewGenerator.generateMealAnalysis(meal);
        meal.setReview(review);
        mealRepository.save(meal);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one is the easiest to update, as it does not require any processing whatsoever.
We take the AI response as-is and update the <code>review</code> column of our <code>Meal</code> table.
To test this, just like we did for the caloric intake, simply create a new meal.
After a couple of minutes, you should get all the information, including caloric impact and review.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">6.4. Conclusion</h3>
<div class="paragraph">
<p>If you reached the end of this chapter, then congratulations!
You have successfully created your small nutrition adviser app with the ability to use LLM for making more advanced decisions quicker.
If you enjoyed this part, please keep it up and stay with the next final chapter, where we are going to implement some asynchronous
operations that will allow us to have a smoother user experience and give you some ideas what you can do to improve the application,
while exploring every part of it.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_app_optimisations_and_ideas">7. App optimisations and ideas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned earlier, we are closing up the end of our work shop and the goal of this chapter will wrap things up.
This does not necessarily mean that you have to stop here.
Get inspired! Think of ideas how you can extend or improve the functionality of this application, or how you can apply the
acquired knowledge in your current or future projects.</p>
</div>
<div class="paragraph">
<p>Without much further ado. Let&#8217;s get to the final steps of completing our project.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_asynchronous_calls_to_the_llm">7.1. Setting up Asynchronous calls to the LLM</h3>
<div class="paragraph">
<p>As I mentioned in the earlier chapters, we were supposed to call the LLM asynchronously.
The reason for that is due to the slow responses that the LLM computes.
In a real world scenario, where LLMs are powered by powerful and expensive servers, this won&#8217;t be such an issue,
but perhaps you might want to offload some of the computations that the user is not concerned to get right away.
In this section I am going to show you how this could be done, using Spring&#8217;s <code>@Async</code> capabilities.</p>
</div>
<div class="sect3">
<h4 id="_enabling_the_async_annotation">7.1.1. Enabling the <code>@Async</code> annotation</h4>
<div class="paragraph">
<p>In order to run your code asynchronously, you simply need to place the <code>@org.springframework.scheduling.annotation.Asynchronus</code>
annotation on a public bean method that you want to make asynchronous.
Before you are able to do that, though, you will need to first enable those capabilities, so when your Spring application
boots up, it will scan and activate the methods, annotated with <code>@Async</code>.</p>
</div>
<div class="paragraph">
<p>To enable asynchronous invocations, simply create a configuration class in the config package.
I shall call mine <code>SpringAsyncConfiguration</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.context.annotation.Configuration</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.springframework.scheduling.annotation.EnableAsync</span>;

<span style="color:#007">@Configuration</span>
<span style="color:#007">@EnableAsync</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">SpringAsyncConfiguration</span> {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when you start up the application, Spring will know that all public methods annotated with <code>@Async</code> should be run asynchronously.</p>
</div>
</div>
<div class="sect3">
<h4 id="_making_llm_calls_asynchronous">7.1.2. Making LLM calls asynchronous</h4>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Although this part is fairly easy, you might feel a bit struggle, making everything work in asynchronous order.
Don&#8217;t let that discourage you. If you ever get stuck you can always use techniques such as logging, to help you out and see what&#8217;s happening.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Right now we made our implementation so that all of our LLM calls are in one place only - in the <code>NutritionAdviserService</code>
If you dealt with asynchronous invocations before, you should already know that converting out <code>obtainMealDataFromLLM</code> method to this&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span style="color:#088;font-weight:bold">public</span> CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Void</span>&gt; obtainMealDataFromLLM(MealCreatedEvent event) {
        ...
        return CompletableFuture.completedFuture(<span style="color:#069">null</span>);
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;should be enough to run all the LLM calls asynchronously.</p>
</div>
<div class="paragraph">
<p>Although correct, this approach won&#8217;t be good enough, because it will not run our LLM calls separately, but rather it will run them
sequentially, which is kind of not using all the available resources we have, to make this quicker.
One other issue is that with this approach we are constrained by Spring&#8217;s design of running asynchronous methods meaning that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can&#8217;t call asynchronous methods if they are private</p>
</li>
<li>
<p>You can&#8217;t call asynchronous methods in the same class even if they are public</p>
</li>
<li>
<p>You can only call one asynchronous method from a bean outside.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since this is an event handler, we can make all the three LLM methods inside public and async, or there could be a simpler
approach. Let&#8217;s make a helper class in the <code>utils</code> folder and call it <code>AsyncInvocationService</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AsyncInvocationService</span> {

    <span style="color:#007">@Async</span>
    <span style="color:#007">@Transactional</span>(Transactional.TxType.REQUIRES_NEW) <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">public</span> CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Void</span>&gt; run(<span style="color:#0a8;font-weight:bold">Runnable</span> procedure) {
        <span style="color:#080;font-weight:bold">try</span> {
            procedure.run(); <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="color:#080;font-weight:bold">return</span> CompletableFuture.completedFuture(<span style="color:#069">null</span>);
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">Exception</span> e) {
            <span style="color:#777">//log the error</span>
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Failed to execute asynchronous task</span><span style="color:#710">&quot;</span></span>, e);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Since all the invocations do modifications to the database and this call is asynchronous, we want to avoid any optimistic
locks due to running the action on a separate thread. To do so, we will tell Hibernate to start a new transaction here.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>All the code we want to run asynchronously will be executed at this point, leaving the main thread clean from the exceptional
time delays the LLM needs to compute its data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now when we go back to our <code>NutritionAdviserService</code>, we can make our <code>obtainMealDataFromLLM</code> method look like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> AsyncInvocationService async;

    ...

    <span style="color:#007">@EventListener</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> obtainMealDataFromLLM(MealCreatedEvent event) {
        Meal meal = event.getMeal();
        async.run(() -&gt; obtainNutrientData(meal));
        async.run(() -&gt; obtainCaloricData(meal));
        async.run(() -&gt; obtainMealReview(meal));
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pretty straightforward, right?</p>
</div>
<div class="paragraph">
<p>Now when you create a new meal, you&#8217;ll most probably not see the additional data, such as meal review or caloric information
you used to see before, but on the other hand the task will complete in an instant.
If you wait for 1-2 minutes and try to get that information through the GET requests, though, you should eventually see those
results being generated right in front of your eyes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_important_application_events">7.2. Logging important application events</h3>
<div class="paragraph">
<p>Adding asynchronous invocations can sometimes create quite a headache, as running the code on a separate thread,
prevents any errors form appearing in the application&#8217;s log.
This can sometimes be a problem, as you are not able to tackle what is going on and why your actions have no outcome.
Debugging might also be difficult, as breakpoints can sometimes be missed by the IDE.
To help us out in this scenario, we will need to add logs to the most important places, where we feel like something might go wrong.</p>
</div>
<div class="paragraph">
<p>We just need to simply create one more class, called <code>LoggerConfiguration</code> in the <code>config</code> package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Configuration</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LoggerConfiguration</span> {

    <span style="color:#007">@Bean</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">Logger</span> producerLogger(InjectionPoint injectionPoint) {
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#0a8;font-weight:bold">Logger</span>.getLogger(injectionPoint.getMember().getDeclaringClass().getName());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This bean configuration class will autowire an instance of a Logger, wherever we need one.
<br>
Here is one example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AsyncInvocationService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">Logger</span> log;

    <span style="color:#007">@Async</span>
    <span style="color:#007">@Transactional</span>(Transactional.TxType.REQUIRES_NEW)
    <span style="color:#088;font-weight:bold">public</span> CompletableFuture&lt;<span style="color:#0a8;font-weight:bold">Void</span>&gt; run(<span style="color:#0a8;font-weight:bold">Runnable</span> procedure) {
        <span style="color:#080;font-weight:bold">try</span> {
            procedure.run();
            <span style="color:#080;font-weight:bold">return</span> CompletableFuture.completedFuture(<span style="color:#069">null</span>);
        } <span style="color:#080;font-weight:bold">catch</span> (<span style="color:#C00;font-weight:bold">Exception</span> e) {
            log.severe(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Failed to execute asynchronous task: %s</span><span style="color:#710">&quot;</span></span>.formatted(e.getMessage()));
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">IllegalStateException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Failed to execute asynchronous task</span><span style="color:#710">&quot;</span></span>, e);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I will leave you to decide where are the important places to place your log messages and see how everything comes into action. üòâ</p>
</div>
</div>
<div class="sect2">
<h3 id="_additional_ideas_to_look_far_and_beyond">7.3. Additional ideas to look far and beyond</h3>
<div class="paragraph">
<p>We‚Äôve reached the end of this workshop!</p>
</div>
<div class="paragraph">
<p>Following a guide is great, but you know what will really deepen your understanding? Getting your hands dirty.</p>
</div>
<div class="paragraph">
<p>Here are a few ideas to take this project further:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Think of other areas where you can apply LLM computations.</p>
</li>
<li>
<p>Extend the app with features you feel are missing.</p>
</li>
<li>
<p>Experiment with new prompts to improve response quality.</p>
</li>
<li>
<p>Try using different LLM models and compare the results.</p>
</li>
<li>
<p>Integrate this idea into your own project.</p>
</li>
<li>
<p>Research how to fine-tune an LLM for more topic-specific accuracy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I truly hope you enjoyed this workshop and that it inspired you to build your own LLM-powered applications!
Let‚Äôs aim for a future where AI and LLMs aren&#8217;t seen as threats to our jobs, but as powerful tools that bridge the gap between vast knowledge and fast action.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-09-17 18:11:55 +0300
</div>
</div>
<script>
;(function () { /*! Asciidoctor Tabs | Copyright (c) 2018-present Dan Allen | MIT License */
  'use strict'

  var config = (document.currentScript || {}).dataset || {}
  var forEach = Array.prototype.forEach

  init(document.querySelectorAll('.tabs'))

  function init (tabsBlocks) {
    if (!tabsBlocks.length) return
    forEach.call(tabsBlocks, function (tabs) {
      var syncIds = tabs.classList.contains('is-sync') ? {} : undefined
      var tablist = tabs.querySelector('.tablist ul')
      tablist.setAttribute('role', 'tablist')
      var start
      forEach.call(tablist.querySelectorAll('li'), function (tab, idx) {
        tab.tabIndex = -1
        tab.setAttribute('role', tab.classList.add('tab') || 'tab')
        var id, anchor, syncId
        if (!(id = tab.id) && (anchor = tab.querySelector('a[id]'))) {
          id = tab.id = anchor.parentNode.removeChild(anchor).id
        }
        var panel = id && tabs.querySelector('.tabpanel[aria-labelledby~="' + id + '"]')
        if (!panel) return idx ? undefined : toggleSelected(tab, true) // invalid state
        syncIds && (((syncId = tab.textContent.trim()) in syncIds) ? (syncId = undefined) : true) &&
        (syncIds[(tab.dataset.syncId = syncId)] = tab)
        idx || (syncIds && (start = { tab: tab, panel: panel })) ? toggleHidden(panel, true) : toggleSelected(tab, true)
        tab.setAttribute('aria-controls', panel.id)
        panel.setAttribute('role', 'tabpanel')
        var onClick = syncId === undefined ? activateTab : activateTabSync
        tab.addEventListener('click', onClick.bind({ tabs: tabs, tab: tab, panel: panel }))
      })
      if (!tabs.closest('.tabpanel')) {
        forEach.call(tabs.querySelectorAll('.tabpanel table.tableblock'), function (table) {
          var container = Object.assign(document.createElement('div'), { className: 'tablecontainer' })
          table.parentNode.insertBefore(container, table).appendChild(table)
        })
      }
      if (start) {
        var syncGroupId
        for (var i = 0, lst = tabs.classList, len = lst.length, className; i !== len; i++) {
          if (!(className = lst.item(i)).startsWith('data-sync-group-id=')) continue
          tabs.dataset.syncGroupId = syncGroupId = lst.remove(className) || className.slice(19).replace(/\u00a0/g, ' ')
          break
        }
        if (syncGroupId === undefined) tabs.dataset.syncGroupId = syncGroupId = Object.keys(syncIds).sort().join('|')
        var preferredSyncId = 'syncStorageKey' in config &&
          window[(config.syncStorageScope || 'local') + 'Storage'].getItem(config.syncStorageKey + '-' + syncGroupId)
        var tab = preferredSyncId && syncIds[preferredSyncId]
        tab && Object.assign(start, { tab: tab, panel: document.getElementById(tab.getAttribute('aria-controls')) })
        toggleSelected(start.tab, true) || toggleHidden(start.panel, false)
      }
    })
    onHashChange()
    toggleClassOnEach(tabsBlocks, 'is-loading', 'remove')
    window.setTimeout(toggleClassOnEach.bind(null, tabsBlocks, 'is-loaded', 'add'), 0)
    window.addEventListener('hashchange', onHashChange)
  }

  function activateTab (e) {
    var tab = this.tab
    var tabs = this.tabs || (this.tabs = tab.closest('.tabs'))
    var panel = this.panel || (this.panel = document.getElementById(tab.getAttribute('aria-controls')))
    querySelectorWithSiblings(tabs, '.tablist .tab', 'tab').forEach(function (el) {
      toggleSelected(el, el === tab)
    })
    querySelectorWithSiblings(tabs, '.tabpanel', 'tabpanel').forEach(function (el) {
      toggleHidden(el, el !== panel)
    })
    if (!this.isSync && 'syncStorageKey' in config && 'syncGroupId' in tabs.dataset) {
      var storageKey = config.syncStorageKey + '-' + tabs.dataset.syncGroupId
      window[(config.syncStorageScope || 'local') + 'Storage'].setItem(storageKey, tab.dataset.syncId)
    }
    if (!e) return
    var loc = window.location
    var hashIdx = loc.hash ? loc.href.indexOf('#') : -1
    if (~hashIdx) window.history.replaceState(null, '', loc.href.slice(0, hashIdx))
    e.preventDefault()
  }

  function activateTabSync (e) {
    activateTab.call(this, e)
    var thisTabs = this.tabs
    var thisTab = this.tab
    var initialY = thisTabs.getBoundingClientRect().y
    forEach.call(document.querySelectorAll('.tabs'), function (tabs) {
      if (tabs === thisTabs || tabs.dataset.syncGroupId !== thisTabs.dataset.syncGroupId) return
      querySelectorWithSiblings(tabs, '.tablist .tab', 'tab').forEach(function (tab) {
        if (tab.dataset.syncId === thisTab.dataset.syncId) activateTab.call({ tabs: tabs, tab: tab, isSync: true })
      })
    })
    var shiftedBy = thisTabs.getBoundingClientRect().y - initialY
    if (shiftedBy && (shiftedBy = Math.round(shiftedBy))) window.scrollBy({ top: shiftedBy, behavior: 'instant' })
  }

  function querySelectorWithSiblings (scope, selector, siblingClass) {
    var el = scope.querySelector(selector)
    if (!el) return []
    var result = [el]
    while ((el = el.nextElementSibling) && el.classList.contains(siblingClass)) result.push(el)
    return result
  }

  function toggleClassOnEach (elements, className, method) {
    forEach.call(elements, function (el) {
      el.classList[method](className)
    })
  }

  function toggleHidden (el, state) {
    el.classList[(el.hidden = state) ? 'add' : 'remove']('is-hidden')
  }

  function toggleSelected (el, state) {
    el.setAttribute('aria-selected', '' + state)
    el.classList[state ? 'add' : 'remove']('is-selected')
    el.tabIndex = state ? 0 : -1
  }

  function onHashChange () {
    var id = window.location.hash.slice(1)
    if (!id) return
    var tab = document.getElementById(~id.indexOf('%') ? decodeURIComponent(id) : id)
    if (!(tab && tab.classList.contains('tab'))) return
    'syncId' in tab.dataset ? activateTabSync.call({ tab: tab }) : activateTab.call({ tab: tab })
  }
})()
</script>
</body>
</html>